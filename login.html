<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover" />
  <title>iBlue Uganda â€¢ sign in</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(145deg, #e6eef5 0%, #d9e3ec 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      min-height: 100dvh;
      margin: 0;
      padding: 16px;
      background-attachment: fixed;
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 2rem 1.5rem;
      border-radius: 32px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 20px 40px -12px rgba(0, 35, 45, 0.25), 0 4px 18px rgba(0,0,0,0.05);
      border: 1px solid rgba(255,255,255,0.5);
    }

    h1 {
      font-size: 2.1rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      text-align: center;
      color: #0B4F6C;
      margin-bottom: 0.5rem;
      margin-top: 0.25rem;
      line-height: 1.1;
    }

    .brand-tag {
      text-align: center;
      font-size: 0.9rem;
      font-weight: 400;
      color: #3a6e7f;
      margin-bottom: 2rem;
      border-bottom: 1.5px solid rgba(11, 79, 108, 0.12);
      padding-bottom: 1rem;
      letter-spacing: 0.3px;
    }

    input {
      width: 100%;
      padding: 15px 18px;
      margin-bottom: 1rem;
      border-radius: 18px;
      border: 1.5px solid #e2e9f0;
      background: #ffffff;
      font-size: 1rem;
      line-height: 1.4;
      color: #0a2e3a;
      transition: border 0.15s, box-shadow 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }

    input:focus {
      border-color: #0B4F6C;
      outline: 0;
      box-shadow: 0 0 0 4px rgba(11, 79, 108, 0.12);
    }

    input:-webkit-autofill {
      -webkit-box-shadow: 0 0 0 50px white inset;
      -webkit-text-fill-color: #0a2e3a;
    }

    .remember-me {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 0 5px;
    }

    .remember-me input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      margin-bottom: 0;
      accent-color: #0B4F6C;
      cursor: pointer;
    }

    .remember-me label {
      font-size: 0.95rem;
      color: #2c3e50;
      cursor: pointer;
      font-weight: 500;
      user-select: none;
    }

    button {
      width: 100%;
      padding: 15px 18px;
      border: none;
      border-radius: 30px;
      font-size: 1.06rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.3px;
      background: #0B4F6C;
      color: white;
      box-shadow: 0 10px 18px -8px rgba(11, 79, 108, 0.4);
      margin-bottom: 0.8rem;
      border: 1px solid rgba(255,255,255,0.2);
    }

    button:active {
      transform: scale(0.98);
      box-shadow: 0 5px 12px -6px rgba(11, 79, 108, 0.5);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    /* Links section */
    .auth-links {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.2rem;
      font-size: 0.95rem;
      flex-wrap: wrap;
      gap: 10px;
    }

    .auth-links a {
      color: #0B4F6C;
      text-decoration: none;
      font-weight: 600;
      padding: 8px 0;
      transition: color 0.2s;
      border-bottom: 2px solid transparent;
    }

    .auth-links a:hover {
      color: #052a38;
      border-bottom-color: #0B4F6C;
    }

    .auth-links .register-link {
      background: rgba(11, 79, 108, 0.08);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 600;
    }

    .auth-links .register-link:hover {
      background: rgba(11, 79, 108, 0.15);
      border-bottom: none;
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 1.5rem 0 0.5rem;
      color: #7a8e9e;
      font-size: 0.85rem;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .divider::before {
      margin-right: 0.5rem;
    }

    .divider::after {
      margin-left: 0.5rem;
    }

    .msg {
      margin-top: 1.5rem;
      padding: 1rem;
      text-align: center;
      border-radius: 40px;
      font-size: 0.95rem;
      font-weight: 500;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
      line-height: 1.4;
    }

    .msg.show {
      display: block;
      opacity: 1;
    }

    .msg.success {
      background: #e1f7ed;
      color: #0a5c46;
      border-left: 6px solid #1e9b7a;
    }

    .msg.error {
      background: #ffe9e9;
      color: #b13e3e;
      border-left: 6px solid #c74a4a;
    }

    .msg.info {
      background: #e1f0fa;
      color: #0b4f6c;
      border-left: 6px solid #0B4F6C;
    }

    @media (max-width: 400px) {
      .card { padding: 1.75rem 1.2rem; }
      h1 { font-size: 1.9rem; }
    }

    @media (max-height: 600px) and (orientation: landscape) {
      body { padding: 12px; }
      .card { padding: 1.25rem; }
      h1 { font-size: 1.8rem; margin-bottom: 0.2rem; }
      input { padding: 12px 16px; margin-bottom: 0.6rem; }
    }

    button, input {
      -webkit-tap-highlight-color: transparent;
    }

    button:focus-visible, input:focus-visible, a:focus-visible {
      outline: 3px solid #0B4F6C;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>iBlue</h1>
    <div class="brand-tag">Uganda â€¢ smart access</div>
    
    <input id="email" type="email" placeholder="Email address" inputmode="email" autocomplete="email" autocapitalize="off" spellcheck="false" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    
    <div class="remember-me">
      <input type="checkbox" id="rememberMe" checked>
      <label for="rememberMe">Remember me on this device</label>
    </div>
    
    <button id="loginBtn">Sign in â†’</button>
    
    <!-- Auth Links: Register and Forgot Password -->
    <div class="auth-links">
      <a href="forgot-password.html" class="forgot-link">Forgot password?</a>
      <a href="register.html" class="register-link">Create account â†’</a>
    </div>
    
    <div class="divider">secure login</div>
    
    <div id="msg" class="msg" role="status"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function() {
      "use strict";

      // Supabase configuration
      const supabaseUrl = "https://uufhvmmgwzkxvvdbqemz.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1Zmh2bW1nd3preHZ2ZGJxZW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDIzNTYsImV4cCI6MjA4NTg3ODM1Nn0.WABHx4ilFRkhPHP-y4ZC4E8Kb7PRqY-cyxI8cVS8Tyc";
      const sb = supabase.createClient(supabaseUrl, supabaseKey, { 
        auth: { 
          flowType: 'pkce',
          autoRefreshToken: true,
          detectSessionInUrl: true,
          persistSession: true
        } 
      });

      // Allowed redirect URLs
      const ALLOWED_REDIRECTS = [
        'https://iblueug.github.io/dashboard.html',
        'https://iblueug.github.io/messages.html',
        'https://iblueug.github.io/profile.html',
        'https://iblueug.github.io/chat.html',
        'https://iblueug.github.io/my-ads.html',
        'https://iblueug.github.io/post-ad.html',
        'https://iblueug.github.io/saved-ads.html'
      ];

      const DEFAULT_REDIRECT = 'https://iblueug.github.io/dashboard.html';

      // DOM elements
      const msgEl = document.getElementById('msg');
      const loginBtn = document.getElementById('loginBtn');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const rememberMeCheckbox = document.getElementById('rememberMe');

      // --- Message handler ---
      function showMessage(text, type = 'error') {
        if (!msgEl) return;
        msgEl.textContent = text;
        msgEl.className = 'msg show ' + type;
        
        if (type === 'success') {
          setTimeout(() => {
            msgEl.classList.remove('show');
          }, 4000);
        }
      }

      // --- Get intended redirect ---
      function getIntendedRedirect() {
        // Priority 1: URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const urlRedirect = urlParams.get('redirect');
        
        if (urlRedirect && ALLOWED_REDIRECTS.includes(urlRedirect)) {
          return urlRedirect;
        }
        
        // Priority 2: sessionStorage
        const sessionRedirect = sessionStorage.getItem('intendedPage');
        if (sessionRedirect && ALLOWED_REDIRECTS.includes(sessionRedirect)) {
          sessionStorage.removeItem('intendedPage');
          return sessionRedirect;
        }
        
        // Priority 3: localStorage
        const localRedirect = localStorage.getItem('intendedPage');
        if (localRedirect && ALLOWED_REDIRECTS.includes(localRedirect)) {
          localStorage.removeItem('intendedPage');
          return localRedirect;
        }
        
        return DEFAULT_REDIRECT;
      }

      // --- Save credentials ---
      function saveCredentials(email) {
        if (rememberMeCheckbox.checked) {
          localStorage.setItem('savedEmail', email);
          localStorage.setItem('rememberMe', 'true');
        } else {
          localStorage.removeItem('savedEmail');
          localStorage.setItem('rememberMe', 'false');
        }
      }

      // --- Load saved email ---
      function loadSavedCredentials() {
        const savedEmail = localStorage.getItem('savedEmail');
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        
        if (savedEmail && rememberMe) {
          emailInput.value = savedEmail;
          rememberMeCheckbox.checked = true;
        }
      }

      // --- Process redirect parameter ---
      function processUrlRedirect() {
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect');
        
        if (redirect && ALLOWED_REDIRECTS.includes(redirect)) {
          if (rememberMeCheckbox.checked) {
            localStorage.setItem('intendedPage', redirect);
          } else {
            sessionStorage.setItem('intendedPage', redirect);
          }
          
          const cleanUrl = window.location.pathname;
          history.replaceState({}, document.title, cleanUrl);
        }
      }

      // --- Login handler ---
      async function loginHandler(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (!email) {
          showMessage('ðŸ“§ Email is required', 'error');
          emailInput.focus();
          return;
        }
        if (!password) {
          showMessage('ðŸ”’ Password cannot be empty', 'error');
          passwordInput.focus();
          return;
        }
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          showMessage('Please enter a valid email address', 'error');
          emailInput.focus();
          return;
        }

        saveCredentials(email);

        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';

        try {
          const { data, error } = await sb.auth.signInWithPassword({ 
            email, 
            password 
          });

          if (error) {
            showMessage(error.message || 'Authentication failed', 'error');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign in â†’';
            return;
          }

          const redirectUrl = getIntendedRedirect();
          showMessage('âœ“ Success! Redirecting...', 'success');
          
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 1000);
          
        } catch (err) {
          showMessage('Network error. Try again.', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign in â†’';
        }
      }

      // --- Check existing session ---
      async function checkExistingSession() {
        try {
          const { data, error } = await sb.auth.getSession();
          
          if (error) {
            console.error('Session check error:', error);
            return;
          }
          
          if (data && data.session) {
            const redirectUrl = getIntendedRedirect();
            if (!window.location.hash) {
              window.location.replace(redirectUrl);
            }
          }
        } catch (e) {
          console.error('Session check error:', e);
        }
      }

      // --- Initialize ---
      document.addEventListener('DOMContentLoaded', () => {
        loadSavedCredentials();
        processUrlRedirect();
        checkExistingSession();
      });

      // Event listeners
      loginBtn.addEventListener('click', loginHandler);

      emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          passwordInput.focus();
        }
      });
      
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loginHandler(e);
        }
      });

      window.addEventListener('pageshow', function() {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign in â†’';
      });

    })();
  </script>
</body>
</html>

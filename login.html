<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover" />
  <title>iBlue Uganda â€¢ sign in</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(145deg, #e6eef5 0%, #d9e3ec 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      min-height: 100dvh;
      margin: 0;
      padding: 16px;
      background-attachment: fixed;
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 2rem 1.5rem;
      border-radius: 32px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 20px 40px -12px rgba(0, 35, 45, 0.25), 0 4px 18px rgba(0,0,0,0.05);
      border: 1px solid rgba(255,255,255,0.5);
    }

    h1 {
      font-size: 2.1rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      text-align: center;
      color: #0B4F6C;
      margin-bottom: 0.5rem;
      margin-top: 0.25rem;
      line-height: 1.1;
    }

    .brand-tag {
      text-align: center;
      font-size: 0.9rem;
      font-weight: 400;
      color: #3a6e7f;
      margin-bottom: 2rem;
      border-bottom: 1.5px solid rgba(11, 79, 108, 0.12);
      padding-bottom: 1rem;
      letter-spacing: 0.3px;
    }

    input {
      width: 100%;
      padding: 15px 18px;
      margin-bottom: 1rem;
      border-radius: 18px;
      border: 1.5px solid #e2e9f0;
      background: #ffffff;
      font-size: 1rem;
      line-height: 1.4;
      color: #0a2e3a;
      transition: border 0.15s, box-shadow 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }

    input:focus {
      border-color: #0B4F6C;
      outline: 0;
      box-shadow: 0 0 0 4px rgba(11, 79, 108, 0.12);
    }

    input:-webkit-autofill {
      -webkit-box-shadow: 0 0 0 50px white inset;
      -webkit-text-fill-color: #0a2e3a;
    }

    /* Remember me checkbox container */
    .remember-me {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 0 5px;
    }

    .remember-me input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      margin-bottom: 0;
      accent-color: #0B4F6C;
      cursor: pointer;
    }

    .remember-me label {
      font-size: 0.95rem;
      color: #2c3e50;
      cursor: pointer;
      font-weight: 500;
      user-select: none;
    }

    button {
      width: 100%;
      padding: 15px 18px;
      border: none;
      border-radius: 30px;
      font-size: 1.06rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.3px;
      background: #0B4F6C;
      color: white;
      box-shadow: 0 10px 18px -8px rgba(11, 79, 108, 0.4);
      margin-bottom: 0.8rem;
      border: 1px solid rgba(255,255,255,0.2);
    }

    button:active {
      transform: scale(0.98);
      box-shadow: 0 5px 12px -6px rgba(11, 79, 108, 0.5);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .google-btn {
      background: white;
      color: #1f2e3a;
      border: 1.5px solid #d4dee6;
      box-shadow: none;
      margin-top: 0.4rem;
      gap: 12px;
      font-weight: 500;
    }

    .google-btn:active {
      background: #f4f8fc;
      border-color: #0B4F6C;
    }

    .google-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="%23FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="%2323A1F1" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="%2334A853" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="%23EA4335" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>') no-repeat center;
      background-size: contain;
    }

    .msg {
      margin-top: 1.5rem;
      padding: 1rem;
      text-align: center;
      border-radius: 40px;
      font-size: 0.95rem;
      font-weight: 500;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
      line-height: 1.4;
    }

    .msg.show {
      display: block;
      opacity: 1;
    }

    .msg.success {
      background: #e1f7ed;
      color: #0a5c46;
      border-left: 6px solid #1e9b7a;
    }

    .msg.error {
      background: #ffe9e9;
      color: #b13e3e;
      border-left: 6px solid #c74a4a;
    }

    .msg.info {
      background: #e1f0fa;
      color: #0b4f6c;
      border-left: 6px solid #0B4F6C;
    }

    @media (max-width: 400px) {
      .card { padding: 1.75rem 1.2rem; }
      h1 { font-size: 1.9rem; }
    }

    @media (max-height: 600px) and (orientation: landscape) {
      body { padding: 12px; }
      .card { padding: 1.25rem; }
      h1 { font-size: 1.8rem; margin-bottom: 0.2rem; }
      input { padding: 12px 16px; margin-bottom: 0.6rem; }
    }

    button, input {
      -webkit-tap-highlight-color: transparent;
    }

    button:focus-visible, input:focus-visible {
      outline: 3px solid #0B4F6C;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>iBlue</h1>
    <div class="brand-tag">Uganda â€¢ smart access</div>
    
    <input id="email" type="email" placeholder="Email address" inputmode="email" autocomplete="email" autocapitalize="off" spellcheck="false" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    
    <!-- Remember Me Checkbox -->
    <div class="remember-me">
      <input type="checkbox" id="rememberMe" checked>
      <label for="rememberMe">Remember me on this device</label>
    </div>
    
    <button id="loginBtn">Sign in â†’</button>
    
    <button id="googleBtn" class="google-btn">
      <span class="google-icon" aria-hidden="true"></span>
      <span>Continue with Google</span>
    </button>
    
    <div id="msg" class="msg" role="status"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function() {
      "use strict";

      // Supabase configuration
      const supabaseUrl = "https://uufhvmmgwzkxvvdbqemz.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1Zmh2bW1nd3preHZ2ZGJxZW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDIzNTYsImV4cCI6MjA4NTg3ODM1Nn0.WABHx4ilFRkhPHP-y4ZC4E8Kb7PRqY-cyxI8cVS8Tyc";
      const sb = supabase.createClient(supabaseUrl, supabaseKey, { 
        auth: { 
          flowType: 'pkce',
          autoRefreshToken: true,
          detectSessionInUrl: true,
          persistSession: true // Important for remember me
        } 
      });

      // Allowed redirects
      const ALLOWED_REDIRECTS = [
        'https://iblueug.github.io/dashboard.html',
        'https://iblueug.github.io/messages.html',
        'https://iblueug.github.io/profile.html',
        'https://iblueug.github.io/chat.html',
        'https://iblueug.github.io/my-ads.html',
        'https://iblueug.github.io/post-ad.html',
        'https://iblueug.github.io/saved-ads.html'
      ];

      const DEFAULT_REDIRECT = 'https://iblueug.github.io/dashboard.html';

      // DOM elements
      const msgEl = document.getElementById('msg');
      const loginBtn = document.getElementById('loginBtn');
      const googleBtn = document.getElementById('googleBtn');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const rememberMeCheckbox = document.getElementById('rememberMe');

      // --- Message handler ---
      function showMessage(text, type = 'error') {
        if (!msgEl) return;
        msgEl.textContent = text;
        msgEl.className = 'msg show ' + type;
        
        if (type === 'success') {
          setTimeout(() => {
            msgEl.classList.remove('show');
          }, 4000);
        }
      }

      // --- Safe redirect function (FIXED) ---
      function getSafeRedirect(redirectTo) {
        // Check direct parameter
        if (redirectTo && ALLOWED_REDIRECTS.includes(redirectTo)) {
          sessionStorage.removeItem('postLoginRedirect');
          return redirectTo;
        }
        
        // Check sessionStorage
        const storedRedirect = sessionStorage.getItem('postLoginRedirect');
        if (storedRedirect && ALLOWED_REDIRECTS.includes(storedRedirect)) {
          sessionStorage.removeItem('postLoginRedirect');
          return storedRedirect;
        }
        
        // Check localStorage (for remember me persistence)
        const savedRedirect = localStorage.getItem('postLoginRedirect');
        if (savedRedirect && ALLOWED_REDIRECTS.includes(savedRedirect)) {
          localStorage.removeItem('postLoginRedirect');
          return savedRedirect;
        }
        
        return DEFAULT_REDIRECT;
      }

      // --- Check for redirect parameter in URL ---
      function checkForRedirectParam() {
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect');
        if (redirect && ALLOWED_REDIRECTS.includes(redirect)) {
          // Store based on remember me preference
          if (rememberMeCheckbox.checked) {
            localStorage.setItem('postLoginRedirect', redirect);
          } else {
            sessionStorage.setItem('postLoginRedirect', redirect);
          }
          // Clean URL
          const cleanUrl = window.location.pathname;
          history.replaceState({}, document.title, cleanUrl);
        }
      }

      // --- Load saved email if "Remember Me" was checked ---
      function loadSavedCredentials() {
        const savedEmail = localStorage.getItem('savedEmail');
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        
        if (savedEmail && rememberMe) {
          emailInput.value = savedEmail;
          rememberMeCheckbox.checked = true;
        } else {
          rememberMeCheckbox.checked = false;
        }
      }

      // --- Save credentials based on "Remember Me" ---
      function saveCredentials(email) {
        if (rememberMeCheckbox.checked) {
          localStorage.setItem('savedEmail', email);
          localStorage.setItem('rememberMe', 'true');
        } else {
          localStorage.removeItem('savedEmail');
          localStorage.setItem('rememberMe', 'false');
        }
      }

      // --- Email/Password login with Remember Me ---
      async function loginHandler(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        
        // Validation
        if (!email) {
          showMessage('ðŸ“§ Email is required', 'error');
          emailInput.focus();
          return;
        }
        if (!password) {
          showMessage('ðŸ”’ Password cannot be empty', 'error');
          passwordInput.focus();
          return;
        }
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          showMessage('Please enter a valid email address', 'error');
          emailInput.focus();
          return;
        }

        // Save credentials if remember me is checked
        saveCredentials(email);

        // Disable button
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';

        try {
          const { data, error } = await sb.auth.signInWithPassword({ 
            email, 
            password 
          });

          if (error) {
            showMessage(error.message || 'Authentication failed', 'error');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign in â†’';
            return;
          }

          // Success
          showMessage('âœ“ Success! Redirecting...', 'success');
          
          // Get redirect URL and navigate
          const redirectUrl = getSafeRedirect();
          
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 1000);
          
        } catch (err) {
          showMessage('Network error. Try again.', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign in â†’';
        }
      }

      // --- FIXED: Google OAuth with proper redirect handling ---
      async function googleSignInHandler(e) {
        e.preventDefault();
        
        googleBtn.disabled = true;
        googleBtn.style.opacity = '0.7';
        
        try {
          // Get the intended redirect
          const redirectTo = getSafeRedirect();
          
          // Store it in BOTH storages to ensure it survives OAuth
          if (rememberMeCheckbox.checked) {
            localStorage.setItem('postLoginRedirect', redirectTo);
            localStorage.setItem('googleOAuthPending', 'true');
          } else {
            sessionStorage.setItem('postLoginRedirect', redirectTo);
            sessionStorage.setItem('googleOAuthPending', 'true');
          }
          
          // IMPORTANT: Set the redirectTo to your login page
          // This ensures we come back to handle the final redirect
          const { data, error } = await sb.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: window.location.href, // Return to this page
              queryParams: {
                access_type: 'offline',
                prompt: 'consent',
              }
            }
          });
          
          if (error) {
            showMessage(error.message, 'error');
            googleBtn.disabled = false;
            googleBtn.style.opacity = '1';
            sessionStorage.removeItem('googleOAuthPending');
            localStorage.removeItem('googleOAuthPending');
          }
          // If success, Supabase redirects automatically
          
        } catch (err) {
          showMessage('Google signâ€‘in failed', 'error');
          googleBtn.disabled = false;
          googleBtn.style.opacity = '1';
          sessionStorage.removeItem('googleOAuthPending');
          localStorage.removeItem('googleOAuthPending');
        }
      }

      // --- Handle OAuth return (FIXED for Google) ---
      async function handleOAuthReturn() {
        // Check if we're returning from OAuth
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const hasAuth = window.location.hash && 
                       (window.location.hash.includes('access_token') || 
                        window.location.hash.includes('error'));
        
        if (hasAuth) {
          showMessage('Completing Google sign-in...', 'info');
          
          try {
            // Let Supabase process the OAuth callback
            const { data, error } = await sb.auth.getSession();
            
            if (error) {
              showMessage(error.message, 'error');
              return;
            }
            
            if (data && data.session) {
              // Check for stored redirect
              let redirectUrl = sessionStorage.getItem('postLoginRedirect') || 
                               localStorage.getItem('postLoginRedirect') ||
                               DEFAULT_REDIRECT;
              
              // Validate redirect
              if (!ALLOWED_REDIRECTS.includes(redirectUrl)) {
                redirectUrl = DEFAULT_REDIRECT;
              }
              
              // Clean up
              sessionStorage.removeItem('postLoginRedirect');
              sessionStorage.removeItem('googleOAuthPending');
              localStorage.removeItem('postLoginRedirect');
              localStorage.removeItem('googleOAuthPending');
              
              // Save email from Google if remember me is checked
              if (rememberMeCheckbox.checked && data.session.user.email) {
                localStorage.setItem('savedEmail', data.session.user.email);
              }
              
              showMessage('âœ“ Google sign-in successful! Redirecting...', 'success');
              
              // Redirect
              setTimeout(() => {
                window.location.href = redirectUrl;
              }, 1000);
            }
          } catch (e) {
            console.error('OAuth handling error:', e);
            showMessage('Error completing Google sign-in', 'error');
          }
        }
      }

      // --- Session check with Remember Me support ---
      async function checkActiveSession() {
        try {
          const { data, error } = await sb.auth.getSession();
          
          if (error) {
            console.error('Session check error:', error);
            return;
          }
          
          if (data && data.session) {
            // Check if this was from Google OAuth
            const isGoogleOAuth = sessionStorage.getItem('googleOAuthPending') || 
                                 localStorage.getItem('googleOAuthPending');
            
            if (isGoogleOAuth) {
              // Let handleOAuthReturn deal with it
              return;
            }
            
            // Normal session - redirect to intended page
            const redirectUrl = getSafeRedirect();
            
            // Only redirect if we're not already on the redirect page
            if (!window.location.pathname.includes('login')) {
              window.location.replace(redirectUrl);
            }
          }
        } catch (e) {
          console.error('Session check error:', e);
        }
      }

      // --- Initialize ---
      document.addEventListener('DOMContentLoaded', () => {
        loadSavedCredentials();
        checkForRedirectParam();
        
        // Check if returning from OAuth
        if (window.location.hash && 
            (window.location.hash.includes('access_token') || 
             window.location.hash.includes('error'))) {
          handleOAuthReturn();
        } else {
          checkActiveSession();
        }
      });

      // Event listeners
      loginBtn.addEventListener('click', loginHandler);
      googleBtn.addEventListener('click', googleSignInHandler);

      // Enter key handlers
      emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          passwordInput.focus();
        }
      });
      
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loginHandler(e);
        }
      });

      // Re-enable buttons on page show
      window.addEventListener('pageshow', function() {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign in â†’';
        googleBtn.disabled = false;
        googleBtn.style.opacity = '1';
      });

    })();
  </script>
</body>
</html>

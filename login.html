<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ultra-responsive viewport â€“ works on all mobile screens -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover" />
  <title>iBlue Uganda â€¢ sign in</title>
  <!-- modern, system-font stack for crisp mobile typography -->
  <style>
    /* reset & safe area support */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(145deg, #e6eef5 0%, #d9e3ec 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      min-height: 100dvh; /* dynamic viewport, perfect for mobile */
      margin: 0;
      padding: 16px;
      /* ensure background covers even on notch devices */
      background-attachment: fixed;
    }

    /* ultraâ€‘optimised card â€“ truly mobile-first, 99% width on small, never overflows */
    .card {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 2rem 1.5rem;
      border-radius: 32px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 20px 40px -12px rgba(0, 35, 45, 0.25), 0 4px 18px rgba(0,0,0,0.05);
      border: 1px solid rgba(255,255,255,0.5);
      transition: all 0.2s ease;
    }

    /* mobile-optimised spacing */
    h1 {
      font-size: 2.1rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      text-align: center;
      color: #0B4F6C;
      margin-bottom: 0.5rem;
      margin-top: 0.25rem;
      line-height: 1.1;
      word-break: break-word;
    }

    /* subtle tagline â€“ professional, friendly */
    .brand-tag {
      text-align: center;
      font-size: 0.9rem;
      font-weight: 400;
      color: #3a6e7f;
      margin-bottom: 2rem;
      border-bottom: 1.5px solid rgba(11, 79, 108, 0.12);
      padding-bottom: 1rem;
      letter-spacing: 0.3px;
    }

    /* input fields â€“ perfect tap size 48px, thumb-friendly */
    input {
      width: 100%;
      padding: 15px 18px;
      margin-bottom: 1rem;
      border-radius: 18px;
      border: 1.5px solid #e2e9f0;
      background: #ffffff;
      font-size: 1rem;
      line-height: 1.4;
      font-weight: 450;
      color: #0a2e3a;
      transition: border 0.15s, box-shadow 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }

    input:focus {
      border-color: #0B4F6C;
      outline: 0;
      box-shadow: 0 0 0 4px rgba(11, 79, 108, 0.12);
      background: white;
    }

    /* hide autofill background flash (mobile) */
    input:-webkit-autofill {
      -webkit-box-shadow: 0 0 0 50px white inset;
      -webkit-text-fill-color: #0a2e3a;
    }

    /* primary button â€“ big, clear, tactile */
    button {
      width: 100%;
      padding: 15px 18px;
      border: none;
      border-radius: 30px; /* pill shape, modern */
      font-size: 1.06rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.3px;
      background: #0B4F6C;
      color: white;
      box-shadow: 0 10px 18px -8px rgba(11, 79, 108, 0.4);
      margin-bottom: 0.8rem;
      border: 1px solid rgba(255,255,255,0.2);
    }

    button:active {
      transform: scale(0.98);
      box-shadow: 0 5px 12px -6px rgba(11, 79, 108, 0.5);
    }

    /* google button â€“ elegant, clean, mobile contrast */
    .google-btn {
      background: white;
      color: #1f2e3a;
      border: 1.5px solid #d4dee6;
      box-shadow: none;
      margin-top: 0.4rem;
      gap: 12px;
      font-weight: 500;
      backdrop-filter: blur(4px);
    }

    .google-btn:active {
      background: #f4f8fc;
      border-color: #0B4F6C;
    }

    /* google icon â€“ pure SVG, crisp on retina */
    .google-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="%23FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="%2323A1F1" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="%2334A853" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="%23EA4335" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>') no-repeat center;
      background-size: contain;
    }

    /* message container â€“ fluid, nonâ€‘jittery */
    .msg {
      margin-top: 1.5rem;
      padding: 1rem;
      text-align: center;
      border-radius: 40px;
      font-size: 0.95rem;
      font-weight: 500;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
      line-height: 1.4;
      word-break: break-word;
    }

    .msg.show {
      display: block;
      opacity: 1;
    }

    .msg.success {
      background: #e1f7ed;
      color: #0a5c46;
      border-left: 6px solid #1e9b7a;
    }

    .msg.error {
      background: #ffe9e9;
      color: #b13e3e;
      border-left: 6px solid #c74a4a;
    }

    /* tiny spacer for breathing */
    .spacer {
      height: 0.25rem;
    }

    /* extra mobile fine-tuning for very small screens */
    @media (max-width: 400px) {
      .card { padding: 1.75rem 1.2rem; }
      h1 { font-size: 1.9rem; }
    }

    /* landscape mode â€“ still compact */
    @media (max-height: 600px) and (orientation: landscape) {
      body { padding: 12px; }
      .card { padding: 1.25rem; }
      h1 { font-size: 1.8rem; margin-bottom: 0.2rem; }
      input { padding: 12px 16px; margin-bottom: 0.6rem; }
    }

    /* improve tap highlight on mobile */
    button, input {
      -webkit-tap-highlight-color: transparent;
    }

    /* focus-visible accessibility */
    button:focus-visible, input:focus-visible {
      outline: 3px solid #0B4F6C;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- clean branding, mobile legible -->
    <h1>iBlue</h1>
    <div class="brand-tag">Uganda â€¢ smart access</div>
    
    <!-- mobile-optimised inputs with proper semantic -->
    <input id="email" type="email" placeholder="Email address" inputmode="email" autocomplete="email" autocapitalize="off" spellcheck="false" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    
    <!-- primary CTA â€“ easy thumb target -->
    <button id="loginBtn">Sign in â†’</button>
    
    <!-- secondary provider with embedded icon (SVG, no extra request) -->
    <button id="googleBtn" class="google-btn">
      <span class="google-icon" aria-hidden="true"></span>
      <span>Continue with Google</span>
    </button>
    
    <!-- unified status message â€“ dynamic classes -->
    <div id="msg" class="msg" role="status"></div>
  </div>

  <!-- supabase sdk (lightweight, modern) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function() {
      "use strict";

      // --- Supabase professional configuration (PKCE for mobile security) ---
      const supabaseUrl = "https://uufhvmmgwzkxvvdbqemz.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1Zmh2bW1nd3preHZ2ZGJxZW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDIzNTYsImV4cCI6MjA4NTg3ODM1Nn0.WABHx4ilFRkhPHP-y4ZC4E8Kb7PRqY-cyxI8cVS8Tyc";
      const sb = supabase.createClient(supabaseUrl, supabaseKey, { 
        auth: { 
          flowType: 'pkce',
          autoRefreshToken: true,
          detectSessionInUrl: true // essential for OAuth redirect on mobile
        } 
      });

      // --- All allowed redirect URLs (matching Supabase configured URLs) ---
      const ALLOWED_REDIRECTS = [
        'https://iblueug.github.io/dashboard.html',
        'https://iblueug.github.io/messages.html',
        'https://iblueug.github.io/profile.html',
        'https://iblueug.github.io/chat.html',
        'https://iblueug.github.io/my-ads.html',
        'https://iblueug.github.io/post-ad.html',
        'https://iblueug.github.io/saved-ads.html'
      ];

      // --- Default redirect after login (dashboard) ---
      const DEFAULT_REDIRECT = 'https://iblueug.github.io/dashboard.html';

      // --- Helper to validate and get safe redirect URL ---
      function getSafeRedirect(redirectTo) {
        if (redirectTo && ALLOWED_REDIRECTS.includes(redirectTo)) {
          return redirectTo;
        }
        // Check if there's a stored redirect from before login
        const storedRedirect = sessionStorage.getItem('postLoginRedirect');
        if (storedRedirect && ALLOWED_REDIRECTS.includes(storedRedirect)) {
          sessionStorage.removeItem('postLoginRedirect');
          return storedRedirect;
        }
        return DEFAULT_REDIRECT;
      }

      // --- DOM references ---
      const msgEl = document.getElementById('msg');
      const loginBtn = document.getElementById('loginBtn');
      const googleBtn = document.getElementById('googleBtn');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');

      // --- professional message handler (mobile-friendly, clear) ---
      function showMessage(text, type = 'error') {
        if (!msgEl) return;
        msgEl.textContent = text;
        // reset class and set show + type
        msgEl.className = 'msg show ' + type;
        
        // auto-hide only success messages, keep errors persistent
        if (type === 'success') {
          setTimeout(() => {
            msgEl.classList.remove('show');
            // optional: clear text after hide
          }, 4000);
        }
      }

      // --- Check for redirect parameter in URL (e.g., from protected route) ---
      function checkForRedirectParam() {
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect');
        if (redirect && ALLOWED_REDIRECTS.includes(redirect)) {
          sessionStorage.setItem('postLoginRedirect', redirect);
          // Clean URL without refreshing the page
          const cleanUrl = window.location.pathname;
          history.replaceState({}, document.title, cleanUrl);
        }
      }

      // --- Email/Password login with validation & mobile UX ---
      async function loginHandler(e) {
        e.preventDefault(); // avoid any form-like behaviour
        
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (!email) {
          showMessage('ðŸ“§ Email is required', 'error');
          emailInput.focus();
          return;
        }
        if (!password) {
          showMessage('ðŸ”’ Password cannot be empty', 'error');
          passwordInput.focus();
          return;
        }
        // simple email regex â€“ instant feedback
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          showMessage('Please enter a valid email address', 'error');
          emailInput.focus();
          return;
        }

        // disable button to prevent double tap, show loading state
        loginBtn.disabled = true;
        loginBtn.style.opacity = '0.8';
        loginBtn.textContent = 'Signing in...';

        try {
          const { data, error } = await sb.auth.signInWithPassword({ 
            email, 
            password 
          });

          if (error) {
            showMessage(error.message || 'Authentication failed', 'error');
            loginBtn.disabled = false;
            loginBtn.style.opacity = '1';
            loginBtn.textContent = 'Sign in â†’';
            return;
          }

          // success
          showMessage('âœ“ Success! Redirecting...', 'success');
          
          // Get safe redirect URL and navigate
          const redirectUrl = getSafeRedirect();
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 1000);
        } catch (err) {
          showMessage('Network error. Try again.', 'error');
          loginBtn.disabled = false;
          loginBtn.style.opacity = '1';
          loginBtn.textContent = 'Sign in â†’';
        }
      }

      // --- Google OAuth (PKCE ready, mobile redirect) ---
      async function googleSignInHandler(e) {
        e.preventDefault();
        
        // prevent double click
        googleBtn.disabled = true;
        googleBtn.style.opacity = '0.7';
        
        try {
          // Get the intended redirect destination
          const redirectTo = getSafeRedirect();
          
          const { data, error } = await sb.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: redirectTo, // Dynamic redirect based on context
              queryParams: {
                access_type: 'offline',
                prompt: 'consent', // helps mobile to refresh token
              }
            }
          });
          
          if (error) {
            showMessage(error.message, 'error');
            googleBtn.disabled = false;
            googleBtn.style.opacity = '1';
          }
          // If success, supabase redirects automatically; no further action
        } catch (err) {
          showMessage('Google signâ€‘in failed', 'error');
          googleBtn.disabled = false;
          googleBtn.style.opacity = '1';
        }
      }

      // --- Session check: avoid flicker, immediate redirect if already logged in ---
      async function checkActiveSession() {
        try {
          const { data, error } = await sb.auth.getSession();
          if (data && data.session) {
            // user already signed in â€“ redirect to appropriate page
            const redirectUrl = getSafeRedirect();
            window.location.replace(redirectUrl);
          }
        } catch (e) {
          // silent fail â€“ no session, stay on login
        }
      }

      // --- Attach listeners (mobile: also handle touch/click) ---
      loginBtn.addEventListener('click', loginHandler);
      googleBtn.addEventListener('click', googleSignInHandler);

      // check session on load, also after OAuth redirect (pkce)
      document.addEventListener('DOMContentLoaded', () => {
        checkForRedirectParam();
        checkActiveSession();
        
        // set input padding consistency for android
        // subtle: ensure that autofilled inputs look fine
      });

      // optional: password manager hint - just UX
      // handle enter key on inputs (natural mobile form)
      emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          passwordInput.focus();
        }
      });
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loginHandler(e);
        }
      });

      // Re-enable buttons if page gets focus (for recovery)
      window.addEventListener('pageshow', function() {
        loginBtn.disabled = false;
        loginBtn.style.opacity = '1';
        loginBtn.textContent = 'Sign in â†’';
        googleBtn.disabled = false;
        googleBtn.style.opacity = '1';
      });

      // Handle the case when there's an error from OAuth redirect (fragment)
      // show user-friendly message if error present in URL (Supabase adds #error)
      if (window.location.hash && window.location.hash.includes('error=')) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const errorDesc = hashParams.get('error_description') || hashParams.get('error') || 'Authentication error';
        showMessage('Google signâ€‘in: ' + decodeURIComponent(errorDesc), 'error');
        // clean hash to avoid duplicate messages
        history.replaceState(null, '', window.location.pathname);
      }

    })();
  </script>
</body>
</html>

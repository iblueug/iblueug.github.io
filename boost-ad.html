<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boost Your Ad - iBlue Uganda</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563EB;
            --primary-light: #3B82F6;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --gray: #6B7280;
            --light-gray: #E5E7EB;
            --lightest-gray: #F3F4F6;
            --white: #FFFFFF;
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--lightest-gray);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--white);
            padding: 20px 0;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
            text-decoration: none;
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .back-btn:hover {
            color: var(--primary);
        }
        
        .ad-preview {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .ad-image {
            width: 120px;
            height: 120px;
            border-radius: var(--radius);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 32px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .ad-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .ad-details h2 {
            margin-bottom: 8px;
            font-size: 20px;
        }
        
        .ad-price {
            color: var(--danger);
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        /* Current Promotions Section */
        .current-promotions {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .current-promo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius);
            margin-bottom: 10px;
            background: var(--lightest-gray);
        }
        
        .promo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .promo-badge.boost {
            background: rgba(255, 149, 0, 0.1);
            color: #FF9500;
        }
        
        .promo-badge.featured {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }
        
        .promo-badge.urgent {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .promo-time-left {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Promotion Types Grid */
        .promotion-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .promotion-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .promotion-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .promotion-card.popular::before {
            content: 'MOST POPULAR';
            position: absolute;
            top: 12px;
            right: -30px;
            background: var(--warning);
            color: white;
            padding: 4px 30px;
            font-size: 11px;
            font-weight: bold;
            transform: rotate(45deg);
            transform-origin: center;
        }
        
        .promotion-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .promotion-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-bottom: 12px;
        }
        
        .promotion-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .promotion-price {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .promotion-price span {
            font-size: 14px;
            color: var(--gray);
            font-weight: normal;
        }
        
        .benefits-list {
            list-style: none;
            margin: 16px 0;
        }
        
        .benefits-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .benefits-list li i {
            color: var(--secondary);
        }
        
        /* Duration Selector */
        .duration-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .duration-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .duration-btn {
            padding: 12px 16px;
            border: 1px solid var(--light-gray);
            background: var(--white);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 100px;
        }
        
        .duration-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .duration-price {
            display: block;
            font-weight: bold;
            margin-top: 4px;
        }
        
        /* Payment Section */
        .payment-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .payment-method {
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .payment-method.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }
        
        .payment-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--gray);
        }
        
        .payment-method.selected .payment-icon {
            color: var(--primary);
        }
        
        .payment-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .payment-fee {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Total Amount */
        .total-section {
            background: var(--lightest-gray);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            border-top: 1px solid var(--light-gray);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: var(--light-gray);
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--light-gray);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Messages */
        .error-message {
            background: #FEE2E2;
            color: #991B1B;
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none;
        }
        
        .success-message {
            background: #D1FAE5;
            color: #065F46;
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none;
        }
        
        .info-message {
            background: #DBEAFE;
            color: #1E40AF;
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Mobile Money Instructions */
        .mm-details {
            background: var(--lightest-gray);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
        }
        
        .mm-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin: 10px 0;
        }
        
        .mm-reference {
            background: var(--white);
            padding: 10px;
            border-radius: var(--radius);
            font-family: monospace;
            text-align: center;
            margin: 10px 0;
            border: 1px dashed var(--light-gray);
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .copy-btn {
            background: var(--light-gray);
            border: none;
            padding: 5px 10px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: var(--gray);
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .ad-preview {
                flex-direction: column;
                text-align: center;
            }
            
            .ad-image {
                width: 100%;
                height: 200px;
            }
            
            .promotion-types {
                grid-template-columns: 1fr;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
            
            .duration-selector {
                flex-direction: column;
            }
            
            .duration-btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <a href="index.html" class="logo">
                <i class="fas fa-bullhorn"></i>
                iBlue Uganda
            </a>
        </div>
    </div>
    
    <div class="container">
        <a onclick="goBack()" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to My Ads
        </a>
        
        <h1 style="margin-bottom: 30px; font-size: 28px;">Promote Your Ad</h1>
        
        <!-- Error/Success/Info Messages -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        <div class="info-message" id="infoMessage"></div>
        
        <!-- Ad Preview -->
        <div class="ad-preview" id="adPreview">
            <div class="ad-image" id="adImage">
                <i class="fas fa-image"></i>
            </div>
            <div class="ad-details">
                <h2 id="adTitle">Loading ad...</h2>
                <div class="ad-price" id="adPrice">UGX 0</div>
                <div style="color: var(--gray);" id="adLocation">Location: Loading...</div>
                <div style="color: var(--gray); font-size: 14px; margin-top: 4px;" id="adStatus"></div>
            </div>
        </div>
        
        <!-- Current Active Promotions -->
        <div class="current-promotions" id="currentPromotions" style="display: none;">
            <h3 class="section-title">Current Active Promotions</h3>
            <div id="currentPromoList">
                <!-- Current promotions will be loaded here -->
            </div>
        </div>
        
        <!-- Promotion Types -->
        <h2 class="section-title">Select Promotion Type</h2>
        <div class="promotion-types" id="promotionTypes">
            <!-- Promotion cards will be loaded here -->
        </div>
        
        <!-- Duration Selector -->
        <div class="duration-section" id="durationSection" style="display: none;">
            <h3 class="section-title">Select Duration</h3>
            <div class="duration-selector" id="durationSelector">
                <!-- Duration buttons will be added here -->
            </div>
        </div>
        
        <!-- Payment Section -->
        <div class="payment-section">
            <h2 class="section-title">Select Payment Method</h2>
            <div class="payment-methods">
                <div class="payment-method" data-method="mobile_money">
                    <div class="payment-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="payment-name">Mobile Money</div>
                    <div class="payment-fee">No extra fees</div>
                </div>
                
                <div class="payment-method" data-method="card">
                    <div class="payment-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="payment-name">Credit/Debit Card</div>
                    <div class="payment-fee">+2% processing fee</div>
                </div>
                
                <div class="payment-method" data-method="bank">
                    <div class="payment-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="payment-name">Bank Transfer</div>
                    <div class="payment-fee">No extra fees</div>
                </div>
            </div>
            
            <!-- Total Amount -->
            <div class="total-section">
                <div class="total-row">
                    <span>Promotion Cost:</span>
                    <span id="promotionCost">UGX 0</span>
                </div>
                <div class="total-row">
                    <span>Processing Fee:</span>
                    <span id="processingFee">UGX 0</span>
                </div>
                <div class="total-row total-amount">
                    <span>Total to Pay:</span>
                    <span id="totalAmount">UGX 0</span>
                </div>
            </div>
            
            <!-- Terms Checkbox -->
            <div style="margin-top: 20px;">
                <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="termsCheckbox" style="margin-top: 3px;">
                    <span style="font-size: 14px; color: var(--gray);">
                        I agree to the <a href="/terms" style="color: var(--primary);">Terms of Service</a> and understand that this promotion cannot be refunded once activated.
                    </span>
                </label>
            </div>
            
            <!-- Pay Button -->
            <button class="btn" id="payButton" disabled>
                <i class="fas fa-lock"></i>
                Initiate Payment
            </button>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; font-size: 24px;" id="modalTitle">Complete Payment</h2>
            
            <div id="mobileMoneyInstructions" style="display: none;">
                <p style="margin-bottom: 20px;">Please send <strong id="mobileAmount">UGX 0</strong> to:</p>
                
                <div class="mm-details">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 5px;">Send to:</div>
                        <div class="mm-number" id="mobileNumber">0766379462</div>
                        <div style="color: var(--gray); font-size: 14px;">MTN Mobile Money</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-size: 14px; color: var(--gray);">Use this reference:</div>
                            <button class="copy-btn" onclick="copyReference()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <div class="mm-reference" id="mobileReference">BLUE-AD-12345-ABCDEF</div>
                    </div>
                    
                    <div style="background: #FFF3CD; color: #856404; padding: 10px; border-radius: var(--radius); font-size: 13px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>IMPORTANT:</strong> Please use the exact reference above for verification. Your promotion will be activated automatically once payment is verified.
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #E8F5E9; border-radius: var(--radius);">
                    <h4 style="margin-bottom: 10px; color: #2E7D32;">üì± How to pay with MTN Mobile Money:</h4>
                    <ol style="margin-left: 20px; font-size: 14px; color: #1B5E20;">
                        <li>Dial *165# on your phone</li>
                        <li>Select option 1: Send Money</li>
                        <li>Enter merchant number: <strong>0766379462</strong></li>
                        <li>Enter amount: <span id="mobileAmountInstruction">UGX 0</span></li>
                        <li>Enter reference: <strong id="mobileReferenceInstruction">BLUE-AD-12345</strong></li>
                        <li>Enter your PIN to confirm</li>
                    </ol>
                </div>
            </div>
            
            <div id="cardPayment" style="display: none;">
                <!-- Card payment integration would go here -->
                <p style="margin-bottom: 20px; text-align: center; color: var(--gray);">
                    <i class="fas fa-credit-card" style="font-size: 48px; margin-bottom: 20px; display: block;"></i>
                    Card payment integration will be available soon.
                </p>
            </div>
            
            <div id="bankInstructions" style="display: none;">
                <p style="margin-bottom: 20px;">Please transfer <strong id="bankAmount">UGX 0</strong> to:</p>
                <div style="background: var(--lightest-gray); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                    <div style="margin-bottom: 10px;">
                        <strong>Bank:</strong> Absa Bank
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Account Name:</strong> AKATUE701
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Account Number:</strong> 6009706672
                    </div>
                    <div>
                        <strong>Branch:</strong> Kampala Road
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="font-size: 14px; color: var(--gray);">Use this reference:</div>
                        <button class="copy-btn" onclick="copyReference()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="mm-reference" id="bankReference">BLUE-AD-12345-ABCDEF</div>
                </div>
                <p style="color: var(--gray); font-size: 14px; background: #FFF3CD; padding: 10px; border-radius: var(--radius);">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>IMPORTANT:</strong> Include the reference number in your transfer description for verification.
                </p>
            </div>
            
            <div style="margin-top: 30px;">
                <div style="background: #E3F2FD; padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: #0D47A1;">‚è±Ô∏è Payment Status</h4>
                    <p id="paymentStatusText" style="font-size: 14px; color: #0D47A1;">
                        Waiting for payment verification... Your payment will be verified automatically within 5-10 minutes after sending.
                    </p>
                    <div id="paymentTimer" style="font-size: 13px; margin-top: 10px; color: #1565C0;">
                        Reference expires in: <span id="expiryTimer">24:00:00</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button class="btn" id="confirmPayment" style="flex: 1; background: var(--secondary);" onclick="handlePaymentComplete()">
                    <i class="fas fa-check"></i>
                    I have Sent Payment
                </button>
                <button class="btn" style="flex: 1; background: var(--light-gray); color: var(--dark);" id="cancelPayment" onclick="closePaymentModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://uufhvmmgwzkxvvdbqemz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1Zmh2bW1nd3preHZ2ZGJxZW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDIzNTYsImV4cCI6MjA4NTg3ODM1Nn0.WABHx4ilFRkhPHP-y4ZC4E8Kb7PRqY-cyxI8cVS8Tyc';
        
        // Payment Configuration
        const BUSINESS_CONFIG = {
            mobileMoneyNumbers: [
                { name: 'MTN', number: '0766379462' }
            ],
            bankDetails: {
                bankName: 'Absa Bank',
                accountName: 'AKATUE701',
                accountNumber: '6009706672',
                branch: 'Kampala Road'
            },
            companyName: 'iBlue Uganda'
        };
        
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State
        let currentUser = null;
        let currentAd = null;
        let selectedPromotion = null;
        let selectedDuration = 7;
        let selectedPaymentMethod = null;
        let promotionPricing = [];
        let currentPromotions = [];
        let basePrice = 0;
        let currentPaymentVerification = null;
        let verificationInterval = null;
        let expiryInterval = null;
        
        // DOM Elements
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const infoMessage = document.getElementById('infoMessage');
        const adTitle = document.getElementById('adTitle');
        const adPrice = document.getElementById('adPrice');
        const adLocation = document.getElementById('adLocation');
        const adStatus = document.getElementById('adStatus');
        const adImage = document.getElementById('adImage');
        const currentPromotionsDiv = document.getElementById('currentPromotions');
        const currentPromoList = document.getElementById('currentPromoList');
        const promotionTypes = document.getElementById('promotionTypes');
        const durationSection = document.getElementById('durationSection');
        const durationSelector = document.getElementById('durationSelector');
        const promotionCost = document.getElementById('promotionCost');
        const processingFee = document.getElementById('processingFee');
        const totalAmount = document.getElementById('totalAmount');
        const termsCheckbox = document.getElementById('termsCheckbox');
        const payButton = document.getElementById('payButton');
        const paymentModal = document.getElementById('paymentModal');
        const confirmPayment = document.getElementById('confirmPayment');
        const cancelPayment = document.getElementById('cancelPayment');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            
            const urlParams = new URLSearchParams(window.location.search);
            const adId = urlParams.get('ad');
            
            if (!adId) {
                showError('No ad specified');
                return;
            }
            
            await loadAdDetails(adId);
            await loadCurrentPromotions(adId);
            await loadPromotionPricing();
            setupEventListeners();
        });
        
        function goBack() {
            window.location.href = 'my-ads.html';
        }
        
        async function checkAuth() {
            try {
                const { data: { session } } = await sb.auth.getSession();
                
                if (!session) {
                    window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
                    return;
                }
                
                const { data: profile } = await sb
                    .from('profiles')
                    .select('id, full_name, email')
                    .eq('id', session.user.id)
                    .single();
                
                if (profile) {
                    currentUser = profile;
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'login.html';
            }
        }
        
        async function loadAdDetails(adId) {
            try {
                const { data: ad, error } = await sb
                    .from('ads')
                    .select(`
                        *,
                        categories!ads_category_id_fkey(name)
                    `)
                    .eq('id', adId)
                    .eq('status', 'active')
                    .single();
                
                if (error) throw error;
                
                if (!ad) {
                    showError('Ad not found or not active');
                    setTimeout(() => window.location.href = 'my-ads.html', 2000);
                    return;
                }
                
                if (ad.seller_id !== currentUser.id) {
                    showError('You do not own this ad');
                    setTimeout(() => window.location.href = 'my-ads.html', 2000);
                    return;
                }
                
                currentAd = ad;
                
                adTitle.textContent = ad.title || 'Untitled Ad';
                adPrice.textContent = formatPrice(ad.price, ad.currency);
                adLocation.textContent = `Location: ${ad.district || 'Unknown'}, ${ad.region || 'Unknown'}`;
                adStatus.textContent = `Status: ${ad.status.charAt(0).toUpperCase() + ad.status.slice(1)}`;
                
                if (ad.image_urls && ad.image_urls.length > 0) {
                    adImage.innerHTML = `<img src="${ad.image_urls[0]}" alt="${ad.title}" onerror="handleImageError(this)">`;
                }
                
            } catch (error) {
                console.error('Error loading ad:', error);
                showError('Failed to load ad details');
            }
        }
        
        function handleImageError(img) {
            img.parentElement.innerHTML = '<i class="fas fa-image"></i>';
        }
        
        async function loadCurrentPromotions(adId) {
            try {
                const { data: promotions, error } = await sb
                    .from('ad_promotions')
                    .select('*')
                    .eq('ad_id', adId)
                    .eq('is_active', true)
                    .order('ends_at', { ascending: true });
                
                if (error) throw error;
                
                currentPromotions = promotions || [];
                
                if (currentPromotions.length > 0) {
                    currentPromotionsDiv.style.display = 'block';
                    renderCurrentPromotions();
                }
                
            } catch (error) {
                console.error('Error loading current promotions:', error);
            }
        }
        
        function renderCurrentPromotions() {
            let html = '';
            const now = new Date();
            
            currentPromotions.forEach(promo => {
                const endsAt = new Date(promo.ends_at);
                const remainingTime = endsAt - now;
                
                if (remainingTime > 0) {
                    const remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
                    
                    let badgeClass = 'promo-badge ';
                    let badgeIcon = '';
                    
                    switch(promo.promotion_type) {
                        case 'boost':
                            badgeClass += 'boost';
                            badgeIcon = 'fa-rocket';
                            break;
                        case 'featured':
                            badgeClass += 'featured';
                            badgeIcon = 'fa-star';
                            break;
                        case 'urgent':
                            badgeClass += 'urgent';
                            badgeIcon = 'fa-fire';
                            break;
                        default:
                            badgeClass += 'boost';
                            badgeIcon = 'fa-bullhorn';
                    }
                    
                    html += `
                        <div class="current-promo-item">
                            <div>
                                <span class="${badgeClass}">
                                    <i class="fas ${badgeIcon}"></i>
                                    ${promo.promotion_type.charAt(0).toUpperCase() + promo.promotion_type.slice(1)}
                                </span>
                                <div class="promo-time-left">
                                    <i class="fas fa-clock"></i> 
                                    ${remainingDays} days left (ends ${endsAt.toLocaleDateString()})
                                </div>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: var(--primary);">
                                    UGX ${parseInt(promo.amount_paid || 0).toLocaleString()}
                                </span>
                            </div>
                        </div>
                    `;
                }
            });
            
            currentPromoList.innerHTML = html || '<p style="color: var(--gray); text-align: center;">No active promotions</p>';
        }
        
        async function loadPromotionPricing() {
            try {
                const { data: pricing, error } = await sb
                    .from('spotlight_pricing')
                    .select('*')
                    .eq('is_active', true)
                    .order('display_priority');
                
                if (error) throw error;
                
                if (!pricing || pricing.length === 0) {
                    promotionPricing = getDefaultPricing();
                } else {
                    promotionPricing = pricing.map(p => ({
                        id: p.spotlight_type,
                        name: p.package_name,
                        description: p.description || '',
                        daily_rate: p.daily_rate,
                        weekly_rate: p.weekly_rate,
                        monthly_rate: p.monthly_rate,
                        currency: p.currency || 'UGX',
                        benefits: generateBenefits(p.spotlight_type),
                        icon: getPromotionIcon(p.spotlight_type),
                        color: getPromotionColor(p.spotlight_type),
                        display_priority: p.display_priority,
                        popular: p.spotlight_type === 'featured_deals'
                    }));
                }
                
                renderPromotionCards();
                
            } catch (error) {
                console.error('Error loading pricing:', error);
                promotionPricing = getDefaultPricing();
                renderPromotionCards();
            }
        }
        
        function generateBenefits(type) {
            const benefitsMap = {
                'featured_deals': ['Homepage placement', 'Featured section', 'Email promotions', 'Verified badge'],
                'trending_now': ['Trending section', 'Priority visibility', '3x more views', 'Social sharing'],
                'editor_picks': ['Curated selection', 'Premium placement', 'Trust badge', 'Weekly newsletter'],
                'new_arrivals': ['New arrivals section', 'Fresh listing badge', 'Priority in search', 'First-week boost'],
                'budget_finds': ['Budget deals section', 'Value for money badge', 'Price filter priority', 'Weekly deals'],
                'premium_listings': ['Premium badge', 'Top of all listings', 'Detailed analytics', 'Priority support'],
                'local_favorites': ['Local deals section', 'Regional targeting', 'Neighborhood visibility', 'Local ads boost'],
                'verified_sellers': ['Verified seller badge', 'Trust indicator', 'Priority in search', 'Enhanced credibility'],
                'boost': ['3x more views', 'Top of category listings', 'Highlighted in search', 'Priority placement'],
                'featured': ['Homepage placement', 'Featured section', 'Email promotions', 'Verified badge'],
                'urgent': ['URGENT badge', 'Priority placement', 'Push notifications', 'Top of listings'],
                'bump': ['Instant top placement', 'One-time boost', 'Refresh ad visibility']
            };
            
            return benefitsMap[type] || ['Increased visibility', 'Better placement', 'More views', 'Higher engagement'];
        }
        
        function getPromotionIcon(type) {
            const iconMap = {
                'featured_deals': 'fas fa-crown',
                'trending_now': 'fas fa-chart-line',
                'editor_picks': 'fas fa-star',
                'new_arrivals': 'fas fa-newspaper',
                'budget_finds': 'fas fa-tags',
                'premium_listings': 'fas fa-gem',
                'local_favorites': 'fas fa-map-marker-alt',
                'verified_sellers': 'fas fa-check-circle',
                'boost': 'fas fa-chart-line',
                'featured': 'fas fa-crown',
                'urgent': 'fas fa-exclamation-circle',
                'bump': 'fas fa-arrow-up'
            };
            
            return iconMap[type] || 'fas fa-bullhorn';
        }
        
        function getPromotionColor(type) {
            const colorMap = {
                'featured_deals': '#2563EB',
                'trending_now': '#FF9500',
                'editor_picks': '#10B981',
                'new_arrivals': '#8B5CF6',
                'budget_finds': '#EF4444',
                'premium_listings': '#F59E0B',
                'local_favorites': '#3B82F6',
                'verified_sellers': '#10B981',
                'boost': '#FF9500',
                'featured': '#2563EB',
                'urgent': '#EF4444',
                'bump': '#10B981'
            };
            
            return colorMap[type] || '#2563EB';
        }
        
        function getDefaultPricing() {
            return [
                {
                    id: 'boost',
                    name: 'Boost',
                    description: 'Increase visibility in search results and category listings',
                    daily_rate: 5000,
                    weekly_rate: 30000,
                    monthly_rate: 120000,
                    currency: 'UGX',
                    benefits: ['3x more views', 'Top of category listings', 'Highlighted in search', 'Priority placement'],
                    icon: 'fas fa-chart-line',
                    color: '#FF9500'
                },
                {
                    id: 'featured',
                    name: 'Featured',
                    description: 'Show in featured sections and homepage spotlight',
                    daily_rate: 15000,
                    weekly_rate: 90000,
                    monthly_rate: 360000,
                    currency: 'UGX',
                    benefits: ['Homepage placement', 'Featured section', 'Email promotions', 'Verified badge'],
                    icon: 'fas fa-crown',
                    color: '#2563EB',
                    popular: true
                },
                {
                    id: 'urgent',
                    name: 'Urgent',
                    description: 'Add "URGENT" badge and priority placement',
                    daily_rate: 8000,
                    weekly_rate: 45000,
                    monthly_rate: 180000,
                    currency: 'UGX',
                    benefits: ['"URGENT" badge', 'Priority placement', 'Push notifications', 'Top of listings'],
                    icon: 'fas fa-exclamation-circle',
                    color: '#EF4444'
                },
                {
                    id: 'bump',
                    name: 'Bump',
                    description: 'Bump ad to top of listings once',
                    daily_rate: 3000,
                    weekly_rate: null,
                    monthly_rate: null,
                    currency: 'UGX',
                    benefits: ['Instant top placement', 'One-time boost', 'Refresh ad visibility'],
                    icon: 'fas fa-arrow-up',
                    color: '#10B981'
                }
            ];
        }
        
        function renderPromotionCards() {
            let html = '';
            
            promotionPricing.forEach(promo => {
                const hasCurrentPromo = currentPromotions.some(p => 
                    p.promotion_type === promo.id && 
                    new Date(p.ends_at) > new Date()
                );
                
                const isPopular = promo.popular || promo.id === 'featured';
                
                html += `
                    <div class="promotion-card ${isPopular ? 'popular' : ''}" data-type="${promo.id}">
                        <div class="promotion-header">
                            <div>
                                <div class="promotion-icon" style="background: ${promo.color}">
                                    <i class="${promo.icon}"></i>
                                </div>
                                <h3 class="promotion-title">${promo.name}</h3>
                                <p style="color: var(--gray); font-size: 14px; margin-bottom: 12px;">${promo.description}</p>
                            </div>
                            <div class="promotion-price">
                                UGX ${promo.daily_rate.toLocaleString()}
                                <span>/day</span>
                            </div>
                        </div>
                        
                        <ul class="benefits-list">
                            ${promo.benefits.map(benefit => `
                                <li><i class="fas fa-check"></i> ${benefit}</li>
                            `).join('')}
                        </ul>
                        
                        ${hasCurrentPromo ? `
                            <div style="margin-top: 15px; padding: 8px; background: rgba(52, 199, 89, 0.1); border-radius: var(--radius); text-align: center; color: #34c759; font-size: 13px;">
                                <i class="fas fa-check-circle"></i> Already Active
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            promotionTypes.innerHTML = html;
            
            document.querySelectorAll('.promotion-card').forEach(card => {
                card.addEventListener('click', function() {
                    if (!this.querySelector('[style*="Already Active"]')) {
                        selectPromotion(this.dataset.type);
                    }
                });
            });
            
            if (!selectedPromotion && currentPromotions.length === 0) {
                const firstCard = document.querySelector('.promotion-card');
                if (firstCard) {
                    selectPromotion(firstCard.dataset.type);
                }
            }
        }
        
        function selectPromotion(type) {
            const hasActivePromo = currentPromotions.some(p => 
                p.promotion_type === type && 
                new Date(p.ends_at) > new Date()
            );
            
            if (hasActivePromo) {
                showError('This promotion is already active on your ad');
                return;
            }
            
            selectedPromotion = type;
            
            document.querySelectorAll('.promotion-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.type === type && !card.querySelector('[style*="Already Active"]')) {
                    card.classList.add('selected');
                }
            });
            
            durationSection.style.display = 'block';
            
            const promo = promotionPricing.find(p => p.id === type);
            if (promo) {
                renderDurationOptions(promo);
            }
            
            updatePaymentButton();
        }
        
        function renderDurationOptions(promo) {
            durationSelector.innerHTML = '';
            
            if (promo.weekly_rate) {
                const btn = document.createElement('div');
                btn.className = 'duration-btn';
                btn.dataset.days = '7';
                btn.dataset.price = promo.weekly_rate;
                btn.innerHTML = `
                    1 Week
                    <span class="duration-price">UGX ${promo.weekly_rate.toLocaleString()}</span>
                `;
                btn.addEventListener('click', function(e) {
                    selectDuration(e, 7, promo.weekly_rate);
                });
                durationSelector.appendChild(btn);
            }
            
            if (promo.monthly_rate) {
                const btn = document.createElement('div');
                btn.className = 'duration-btn';
                btn.dataset.days = '30';
                btn.dataset.price = promo.monthly_rate;
                btn.innerHTML = `
                    1 Month
                    <span class="duration-price">UGX ${promo.monthly_rate.toLocaleString()}</span>
                `;
                btn.addEventListener('click', function(e) {
                    selectDuration(e, 30, promo.monthly_rate);
                });
                durationSelector.appendChild(btn);
            }
            
            const dailyBtn = document.createElement('div');
            dailyBtn.className = 'duration-btn';
            dailyBtn.dataset.days = '1';
            dailyBtn.dataset.price = promo.daily_rate;
            dailyBtn.innerHTML = `
                ${promo.id === 'bump' ? 'One-time Bump' : '1 Day'}
                <span class="duration-price">UGX ${promo.daily_rate.toLocaleString()}</span>
            `;
            dailyBtn.addEventListener('click', function(e) {
                selectDuration(e, 1, promo.daily_rate);
            });
            durationSelector.appendChild(dailyBtn);
            
            const firstDuration = durationSelector.querySelector('.duration-btn');
            if (firstDuration) {
                firstDuration.classList.add('selected');
                selectDuration(
                    { target: firstDuration },
                    parseInt(firstDuration.dataset.days),
                    parseFloat(firstDuration.dataset.price)
                );
            }
        }
        
        function selectDuration(event, days, price) {
            selectedDuration = days;
            basePrice = price;
            
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            
            updatePricing(price);
        }
        
        function updatePricing(price) {
            const processingFeeAmount = selectedPaymentMethod === 'card' ? price * 0.02 : 0;
            const total = price + processingFeeAmount;
            
            promotionCost.textContent = `UGX ${price.toLocaleString()}`;
            processingFee.textContent = `UGX ${processingFeeAmount.toLocaleString()}`;
            totalAmount.textContent = `UGX ${total.toLocaleString()}`;
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    selectPaymentMethod(this.dataset.method);
                });
            });
            
            termsCheckbox.addEventListener('change', updatePaymentButton);
            payButton.addEventListener('click', initiatePayment);
            cancelPayment.addEventListener('click', closePaymentModal);
            
            selectPaymentMethod('mobile_money');
        }
        
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
                if (m.dataset.method === method) {
                    m.classList.add('selected');
                }
            });
            
            updatePaymentButton();
            
            if (basePrice > 0) {
                updatePricing(basePrice);
            }
        }
        
        function updatePaymentButton() {
            const isReady = selectedPromotion && 
                          selectedDuration && 
                          selectedPaymentMethod && 
                          termsCheckbox.checked;
            
            payButton.disabled = !isReady;
        }
        
        async function initiatePayment() {
            try {
                payButton.innerHTML = '<div class="loading"></div> Initiating...';
                payButton.disabled = true;
                
                let mobileNumber = null;
                if (selectedPaymentMethod === 'mobile_money') {
                    mobileNumber = BUSINESS_CONFIG.mobileMoneyNumbers[0]?.number || '0766379462';
                }
                
                const { data: paymentInit, error: initError } = await sb
                    .rpc('initiate_payment', {
                        p_ad_id: currentAd.id,
                        p_user_id: currentUser.id,
                        p_amount: basePrice,
                        p_payment_method: selectedPaymentMethod,
                        p_mobile_number: mobileNumber
                    });
                
                if (initError) throw initError;
                
                if (!paymentInit.success) {
                    throw new Error(paymentInit.message);
                }
                
                currentPaymentVerification = {
                    transactionId: paymentInit.transaction_id,
                    reference: paymentInit.reference_number,
                    verificationId: paymentInit.verification_id,
                    expiresAt: new Date(paymentInit.expires_at)
                };
                
                showPaymentModal();
                
            } catch (error) {
                console.error('Payment initiation error:', error);
                showError(error.message || 'Failed to initiate payment. Please try again.');
                
                payButton.innerHTML = '<i class="fas fa-lock"></i> Initiate Payment';
                payButton.disabled = false;
            }
        }
        
        function showPaymentModal() {
            const total = parseFloat(totalAmount.textContent.replace(/[^0-9.]/g, ''));
            const reference = currentPaymentVerification.reference;
            
            document.getElementById('mobileMoneyInstructions').style.display = 'none';
            document.getElementById('cardPayment').style.display = 'none';
            document.getElementById('bankInstructions').style.display = 'none';
            
            if (selectedPaymentMethod === 'mobile_money') {
                document.getElementById('mobileMoneyInstructions').style.display = 'block';
                document.getElementById('mobileAmount').textContent = totalAmount.textContent;
                document.getElementById('mobileAmountInstruction').textContent = totalAmount.textContent;
                document.getElementById('mobileReference').textContent = reference;
                document.getElementById('mobileReferenceInstruction').textContent = reference;
                document.getElementById('mobileNumber').textContent = BUSINESS_CONFIG.mobileMoneyNumbers[0]?.number || '0766379462';
                
            } else if (selectedPaymentMethod === 'bank') {
                document.getElementById('bankInstructions').style.display = 'block';
                document.getElementById('bankAmount').textContent = totalAmount.textContent;
                document.getElementById('bankReference').textContent = reference;
                
            } else if (selectedPaymentMethod === 'card') {
                document.getElementById('cardPayment').style.display = 'block';
            }
            
            paymentModal.classList.add('active');
            
            startPaymentVerification();
            startExpiryTimer();
        }
        
        function closePaymentModal() {
            paymentModal.classList.remove('active');
            
            if (verificationInterval) {
                clearInterval(verificationInterval);
                verificationInterval = null;
            }
            
            if (expiryInterval) {
                clearInterval(expiryInterval);
                expiryInterval = null;
            }
            
            payButton.innerHTML = '<i class="fas fa-lock"></i> Initiate Payment';
            payButton.disabled = false;
            
            currentPaymentVerification = null;
        }
        
        function startExpiryTimer() {
            if (expiryInterval) {
                clearInterval(expiryInterval);
            }
            
            function updateTimer() {
                if (!currentPaymentVerification || !currentPaymentVerification.expiresAt) {
                    return;
                }
                
                const now = new Date();
                const expiry = new Date(currentPaymentVerification.expiresAt);
                const diff = expiry - now;
                
                if (diff <= 0) {
                    document.getElementById('expiryTimer').textContent = 'Expired';
                    showInfo('Payment reference has expired. Please initiate a new payment.');
                    closePaymentModal();
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('expiryTimer').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateTimer();
            expiryInterval = setInterval(updateTimer, 1000);
        }
        
        async function startPaymentVerification() {
            if (verificationInterval) {
                clearInterval(verificationInterval);
            }
            
            verificationInterval = setInterval(async () => {
                if (!currentPaymentVerification) {
                    clearInterval(verificationInterval);
                    return;
                }
                
                await checkPaymentStatus();
            }, 5000);
            
            await checkPaymentStatus();
        }
        
        async function checkPaymentStatus() {
            try {
                if (!currentPaymentVerification) return;
                
                const { data: verification, error } = await sb
                    .from('payment_verifications')
                    .select('*')
                    .eq('reference_number', currentPaymentVerification.reference)
                    .single();
                
                if (error) throw error;
                
                if (verification.status === 'verified') {
                    clearInterval(verificationInterval);
                    verificationInterval = null;
                    
                    document.getElementById('paymentStatusText').innerHTML = `
                        <i class="fas fa-check-circle" style="color: #10B981;"></i> 
                        Payment verified! Activating your promotion...
                    `;
                    
                    await activatePromotion(verification);
                    
                } else if (verification.status === 'expired') {
                    clearInterval(verificationInterval);
                    verificationInterval = null;
                    
                    showInfo('Payment reference has expired. Please initiate a new payment.');
                    closePaymentModal();
                }
                
            } catch (error) {
                console.error('Error checking payment status:', error);
            }
        }
        
        function handlePaymentComplete() {
            document.getElementById('paymentStatusText').innerHTML = `
                <i class="fas fa-clock" style="color: #F59E0B;"></i> 
                Thank you! We are now verifying your payment. This usually takes 5-10 minutes.
                You will be notified once verified.
            `;
            
            confirmPayment.disabled = true;
            confirmPayment.style.opacity = '0.5';
        }
        
        async function activatePromotion(verification) {
            try {
                showSuccess('Payment verified! Activating your promotion...');
                
                const transactionId = `TXN-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const { data: promotion, error: promotionError } = await sb
                    .from('ad_promotions')
                    .insert({
                        ad_id: currentAd.id,
                        promotion_type: selectedPromotion,
                        amount_paid: basePrice,
                        currency: 'UGX',
                        payment_method: selectedPaymentMethod,
                        transaction_id: verification.transaction_id,
                        starts_at: new Date().toISOString(),
                        ends_at: new Date(Date.now() + selectedDuration * 24 * 60 * 60 * 1000).toISOString(),
                        is_active: true
                    })
                    .select()
                    .single();
                
                if (promotionError) throw promotionError;
                
                const adUpdate = {};
                switch(selectedPromotion) {
                    case 'boost':
                        adUpdate.boost_until = promotion.ends_at;
                        break;
                    case 'featured':
                        adUpdate.is_featured = true;
                        adUpdate.featured_until = promotion.ends_at;
                        break;
                }
                
                if (Object.keys(adUpdate).length > 0) {
                    const { error: adError } = await sb
                        .from('ads')
                        .update(adUpdate)
                        .eq('id', currentAd.id);
                    
                    if (adError) throw adError;
                }
                
                await sb
                    .from('notifications')
                    .insert({
                        user_id: currentUser.id,
                        type: 'promotion_activated',
                        title: 'Promotion Activated! üéâ',
                        message: `Your ${selectedPromotion} promotion has been activated and will run for ${selectedDuration} days.`,
                        link: `/ad/${currentAd.slug}`,
                        ad_id: currentAd.id
                    });
                
                paymentModal.classList.remove('active');
                showSuccess('Payment verified and promotion activated successfully!');
                
                await loadCurrentPromotions(currentAd.id);
                renderPromotionCards();
                
                selectedPromotion = null;
                selectedDuration = 7;
                basePrice = 0;
                durationSection.style.display = 'none';
                updatePaymentButton();
                currentPaymentVerification = null;
                
                if (expiryInterval) {
                    clearInterval(expiryInterval);
                    expiryInterval = null;
                }
                
            } catch (error) {
                console.error('Promotion activation error:', error);
                showError('Payment was verified but promotion activation failed. Please contact support.');
            }
        }
        
        function copyReference() {
            const reference = document.getElementById('mobileReference')?.textContent || 
                            document.getElementById('bankReference')?.textContent;
            
            if (reference) {
                navigator.clipboard.writeText(reference);
                
                const copyBtn = event.target.closest('.copy-btn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            }
        }
        
        function formatPrice(price, currency = 'UGX') {
            if (!price && price !== 0) return 'Price on request';
            return `UGX ${parseInt(price).toLocaleString()}`;
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            infoMessage.style.display = 'none';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            infoMessage.style.display = 'none';
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }
        
        function showInfo(message) {
            infoMessage.textContent = message;
            infoMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            setTimeout(() => {
                infoMessage.style.display = 'none';
            }, 8000);
        }
    </script>
</body>
</html>
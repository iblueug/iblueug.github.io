<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Account - iBlue Uganda B2B</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563EB;
            --primary-dark: #1D4ED8;
            --primary-light: #3B82F6;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --dark-gray: #4B5563;
            --gray: #6B7280;
            --light-gray: #9CA3AF;
            --lighter-gray: #E5E7EB;
            --lightest-gray: #F3F4F6;
            --white: #FFFFFF;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
            --radius: 12px;
            --radius-lg: 16px;
            --touch-target: 48px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.4;
            color: var(--dark);
            background: var(--lightest-gray);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            padding-bottom: 70px;
        }
        
        button, a {
            min-height: var(--touch-target);
            min-width: var(--touch-target);
        }
        
        button:active, a:active {
            opacity: 0.7;
            transform: scale(0.98);
            transition: all 0.1s;
        }
        
        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--white);
            border-bottom: 1px solid var(--lighter-gray);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
        }
        
        .back-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--lightest-gray);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 20px;
            cursor: pointer;
            text-decoration: none;
            flex-shrink: 0;
        }
        
        .header-title {
            flex: 1;
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Profile Header */
        .profile-header {
            background: var(--white);
            padding: 24px 16px;
            text-align: center;
            border-bottom: 1px solid var(--lighter-gray);
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
            margin: 0 auto 16px;
            position: relative;
            border: 4px solid var(--white);
            box-shadow: var(--shadow);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .verified-badge-large {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: var(--secondary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            border: 3px solid var(--white);
        }
        
        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .profile-email {
            color: var(--gray);
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .profile-badge {
            display: inline-block;
            padding: 6px 16px;
            background: var(--primary-light);
            color: white;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .edit-profile-btn {
            padding: 12px 24px;
            background: var(--white);
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-profile-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 20px 16px;
            background: var(--white);
            border-bottom: 1px solid var(--lighter-gray);
        }
        
        .stat-card {
            text-align: center;
            padding: 12px 8px;
            background: var(--lightest-gray);
            border-radius: var(--radius);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Menu Sections */
        .menu-section {
            background: var(--white);
            margin: 16px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .section-title {
            padding: 16px 16px 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 16px;
            text-decoration: none;
            color: var(--dark);
            border-bottom: 1px solid var(--lighter-gray);
            transition: background 0.2s;
            min-height: var(--touch-target);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:active {
            background: var(--lightest-gray);
        }
        
        .menu-icon {
            width: 40px;
            height: 40px;
            background: var(--lightest-gray);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .menu-content {
            flex: 1;
        }
        
        .menu-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .menu-subtitle {
            font-size: 13px;
            color: var(--gray);
        }
        
        .menu-badge {
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        
        .menu-arrow {
            color: var(--light-gray);
            font-size: 14px;
            margin-left: 12px;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--light-gray);
            border-radius: 34px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .toggle-switch.active {
            background: var(--primary);
        }
        
        .toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: var(--shadow);
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        /* Danger Zone */
        .danger-zone {
            margin: 16px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--danger);
        }
        
        .danger-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--white);
            border-bottom: 1px solid var(--lighter-gray);
            color: var(--danger);
            text-decoration: none;
        }
        
        .danger-item:last-child {
            border-bottom: none;
        }
        
        .danger-icon {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        /* Login State */
        .login-prompt {
            text-align: center;
            padding: 48px 20px;
            background: var(--white);
            margin: 16px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }
        
        .login-prompt i {
            font-size: 64px;
            color: var(--light-gray);
            margin-bottom: 16px;
        }
        
        .login-prompt h3 {
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .login-prompt p {
            color: var(--gray);
            margin-bottom: 24px;
        }
        
        .login-btn {
            display: inline-block;
            padding: 14px 32px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        
        .signup-link {
            margin-top: 16px;
            font-size: 14px;
        }
        
        .signup-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--lighter-gray);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 12px;
            flex: 1;
            padding: 8px 4px;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .modal.active {
            visibility: visible;
            opacity: 1;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 400px;
            padding: 24px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .modal-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--lighter-gray);
            border-radius: var(--radius);
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
        }
        
        .modal-btn.cancel {
            background: var(--lightest-gray);
            color: var(--dark-gray);
        }
        
        .modal-btn.save {
            background: var(--primary);
            color: white;
        }
        
        .modal-btn.delete {
            background: var(--danger);
            color: white;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: var(--dark);
            color: white;
            padding: 14px 20px;
            border-radius: var(--radius);
            font-size: 15px;
            z-index: 2000;
            text-align: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loading i {
            font-size: 32px;
            margin-bottom: 12px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="/index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">My Account</div>
        <div style="width: 44px;"></div> <!-- Spacer for alignment -->
    </header>

    <!-- Main Content -->
    <div class="container" id="accountContent">
        <!-- Content will be loaded dynamically -->
        <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading account...</p>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <h3 class="modal-title">Edit Profile</h3>
            
            <label style="font-size: 14px; color: var(--gray); margin-bottom: 4px; display: block;">Full Name</label>
            <input type="text" class="modal-input" id="editFullName" placeholder="Enter your full name">
            
            <label style="font-size: 14px; color: var(--gray); margin-bottom: 4px; display: block;">Phone Number</label>
            <input type="tel" class="modal-input" id="editPhone" placeholder="+256 XXX XXX XXX">
            
            <label style="font-size: 14px; color: var(--gray); margin-bottom: 4px; display: block;">Location</label>
            <input type="text" class="modal-input" id="editLocation" placeholder="City/District">
            
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelEdit">Cancel</button>
                <button class="modal-btn save" id="saveEdit">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal" id="logoutModal">
        <div class="modal-content">
            <h3 class="modal-title">Logout</h3>
            <p style="color: var(--gray); margin-bottom: 24px;">Are you sure you want to logout?</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelLogout">Cancel</button>
                <button class="modal-btn delete" id="confirmLogout">Logout</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal" id="deleteAccountModal">
        <div class="modal-content">
            <h3 class="modal-title">Delete Account</h3>
            <p style="color: var(--gray); margin-bottom: 24px;">
                This action cannot be undone. All your data will be permanently deleted.
                Please type "DELETE" to confirm.
            </p>
            
            <input type="text" class="modal-input" id="deleteConfirm" placeholder="Type DELETE">
            
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelDelete">Cancel</button>
                <button class="modal-btn delete" id="confirmDelete">Delete Account</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/index.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="/categories.html" class="nav-item">
            <i class="fas fa-th-large nav-icon"></i>
            <span>Shop</span>
        </a>
        <a href="/wholesalers.html" class="nav-item">
            <i class="fas fa-warehouse nav-icon"></i>
            <span>Wholesale</span>
        </a>
        <a href="/saved.html" class="nav-item">
            <i class="far fa-heart nav-icon"></i>
            <span>Saved</span>
        </a>
        <a href="/account.html" class="nav-item active">
            <i class="far fa-user nav-icon"></i>
            <span>Account</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase config
        const SUPABASE_URL = 'https://uufhvmmgwzkxvvdbqemz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1Zmh2bW1nd3preHZ2ZGJxZW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDIzNTYsImV4cCI6MjA4NTg3ODM1Nn0.WABHx4ilFRkhPHP-y4ZC4E8Kb7PRqY-cyxI8cVS8Tyc';
        
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentUser = null;
        let userProfile = null;
        let userStats = {
            activeAds: 0,
            totalAds: 0,
            savedAds: 0,
            unreadMessages: 0
        };

        // DOM Elements
        const accountContent = document.getElementById('accountContent');
        const editProfileModal = document.getElementById('editProfileModal');
        const logoutModal = document.getElementById('logoutModal');
        const deleteAccountModal = document.getElementById('deleteAccountModal');
        const toast = document.getElementById('toast');

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
        });

        // Check authentication
        async function checkAuth() {
            try {
                const { data: { session } } = await sb.auth.getSession();
                
                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                    await loadUserStats();
                    renderLoggedInUI();
                } else {
                    renderLoggedOutUI();
                }
            } catch (error) {
                console.error('Auth error:', error);
                renderLoggedOutUI();
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const { data: profile, error } = await sb
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                
                userProfile = profile;
            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('Failed to load profile');
            }
        }

        // Load user stats
        async function loadUserStats() {
            try {
                // Get active ads count
                const { count: activeAds } = await sb
                    .from('ads')
                    .select('*', { count: 'exact', head: true })
                    .eq('seller_id', currentUser.id)
                    .eq('status', 'active');

                // Get total ads count
                const { count: totalAds } = await sb
                    .from('ads')
                    .select('*', { count: 'exact', head: true })
                    .eq('seller_id', currentUser.id);

                // Get saved ads count
                const { count: savedAds } = await sb
                    .from('saved_ads')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);

                // Get unread messages count
                const { count: unreadMessages } = await sb
                    .from('messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('receiver_id', currentUser.id)
                    .eq('is_read', false);

                userStats = {
                    activeAds: activeAds || 0,
                    totalAds: totalAds || 0,
                    savedAds: savedAds || 0,
                    unreadMessages: unreadMessages || 0
                };

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Render logged in UI
        function renderLoggedInUI() {
            const initials = userProfile?.full_name
                ?.split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2) || 'U';

            const memberSince = userProfile?.created_at 
                ? new Date(userProfile.created_at).toLocaleDateString('en-UG', {
                    year: 'numeric',
                    month: 'long'
                  })
                : 'Recent';

            accountContent.innerHTML = `
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-avatar">
                        ${userProfile?.avatar_url ? 
                            `<img src="${userProfile.avatar_url}" alt="${userProfile.full_name}">` : 
                            initials
                        }
                        ${userProfile?.is_verified ? 
                            '<span class="verified-badge-large"><i class="fas fa-check"></i></span>' : 
                            ''}
                    </div>
                    
                    <h2 class="profile-name">${escapeHtml(userProfile?.full_name || 'Business Name')}</h2>
                    <div class="profile-email">${escapeHtml(userProfile?.email || '')}</div>
                    
                    ${userProfile?.admin_role ? 
                        `<div class="profile-badge">
                            <i class="fas fa-crown"></i> ${userProfile.admin_role.replace('_', ' ')}
                        </div>` : 
                        ''}
                    
                    <button class="edit-profile-btn" onclick="openEditProfile()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${userStats.activeAds}</div>
                        <div class="stat-label">Active Ads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${userStats.totalAds}</div>
                        <div class="stat-label">Total Ads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${userStats.savedAds}</div>
                        <div class="stat-label">Saved</div>
                    </div>
                </div>

                <!-- My Business Section -->
                <div class="section-title">MY BUSINESS</div>
                <div class="menu-section">
                    <a href="/my-ads.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-box"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">My Ads</div>
                            <div class="menu-subtitle">Manage your listings</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="post-ad.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-plus-circle" style="color: var(--secondary);"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Post New Ad</div>
                            <div class="menu-subtitle">Create a listing</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="boast-ad.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-chart-line" style="color: var(--warning);"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Promotions</div>
                            <div class="menu-subtitle">Boost your visibility</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                </div>

                <!-- Activity Section -->
                <div class="section-title">ACTIVITY</div>
                <div class="menu-section">
                    <a href="/messages.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-comment"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">
                                Messages
                                ${userStats.unreadMessages > 0 ? 
                                    `<span class="menu-badge">${userStats.unreadMessages}</span>` : 
                                    ''}
                            </div>
                            <div class="menu-subtitle">Chat with buyers</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="/notifications.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-bell"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Notifications</div>
                            <div class="menu-subtitle">Updates and alerts</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="/saved.html" class="menu-item">
                        <div class="menu-icon"><i class="far fa-heart"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Saved Items</div>
                            <div class="menu-subtitle">${userStats.savedAds} items saved</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="my-ads.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-star"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Reviews & Ratings</div>
                            <div class="menu-subtitle">See what buyers say</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                </div>

                <!-- Settings Section -->
                <div class="section-title">SETTINGS</div>
                <div class="menu-section">
                    <div class="menu-item" onclick="toggleNotificationSettings()">
                        <div class="menu-icon"><i class="fas fa-bell-slash"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Push Notifications</div>
                            <div class="menu-subtitle">Receive alerts</div>
                        </div>
                        <div class="toggle-switch active" id="notificationToggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    
                    <a href="/privacy.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-lock"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Privacy & Security</div>
                            <div class="menu-subtitle">Manage your data</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="/help.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-question-circle"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Help & Support</div>
                            <div class="menu-subtitle">FAQs, contact us</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="/terms.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Terms & Conditions</div>
                            <div class="menu-subtitle">Legal information</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                </div>

                <!-- Danger Zone -->
                <div class="danger-zone">
                    <div class="danger-item" onclick="openLogoutModal()">
                        <div class="danger-icon"><i class="fas fa-sign-out-alt"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Logout</div>
                            <div class="menu-subtitle">Sign out of your account</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </div>
                    
                    <div class="danger-item" onclick="openDeleteAccountModal()">
                        <div class="danger-icon"><i class="fas fa-trash"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Delete Account</div>
                            <div class="menu-subtitle">Permanently remove your account</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </div>
                </div>

                <!-- Member Since -->
                <div style="text-align: center; padding: 20px; color: var(--light-gray); font-size: 12px;">
                    Member since ${memberSince}
                </div>
            `;
        }

        // Render logged out UI
        function renderLoggedOutUI() {
            accountContent.innerHTML = `
                <div class="login-prompt">
                    <i class="fas fa-user-circle"></i>
                    <h3>Welcome to iBlue Uganda</h3>
                    <p>Sign in to manage your account, view messages, and post ads</p>
                    
                    <button class="login-btn" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                    
                    <div class="signup-link">
                        Don't have an account? <a href="/signup.html">Sign up</a>
                    </div>
                </div>

                <!-- Public Info Section -->
                <div class="menu-section" style="margin-top: 20px;">
                    <a href="/help.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-question-circle"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Help & Support</div>
                            <div class="menu-subtitle">FAQs, contact us</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="/terms.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Terms & Conditions</div>
                            <div class="menu-subtitle">Legal information</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    
                    <a href="/privacy.html" class="menu-item">
                        <div class="menu-icon"><i class="fas fa-lock"></i></div>
                        <div class="menu-content">
                            <div class="menu-title">Privacy Policy</div>
                            <div class="menu-subtitle">How we handle your data</div>
                        </div>
                        <span class="menu-arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                </div>
            `;
        }

        // Authentication functions
        async function login() {
            window.location.href = '/login.html?redirect=/account.html';
        }

        async function logout() {
            try {
                await sb.auth.signOut();
                currentUser = null;
                userProfile = null;
                showToast('Logged out successfully', 'success');
                renderLoggedOutUI();
                logoutModal.classList.remove('active');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Failed to logout', 'error');
            }
        }

        // Profile editing
        function openEditProfile() {
            document.getElementById('editFullName').value = userProfile?.full_name || '';
            document.getElementById('editPhone').value = userProfile?.phone || '';
            document.getElementById('editLocation').value = userProfile?.location || '';
            editProfileModal.classList.add('active');
        }

        async function saveProfile() {
            const fullName = document.getElementById('editFullName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const location = document.getElementById('editLocation').value.trim();

            if (!fullName) {
                showToast('Please enter your full name', 'warning');
                return;
            }

            try {
                const { error } = await sb
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        phone: phone,
                        location: location,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Update local profile
                userProfile = {
                    ...userProfile,
                    full_name: fullName,
                    phone: phone,
                    location: location
                };

                showToast('Profile updated successfully', 'success');
                editProfileModal.classList.remove('active');
                renderLoggedInUI(); // Refresh UI

            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Failed to update profile', 'error');
            }
        }

        // Modal controls
        function openLogoutModal() {
            logoutModal.classList.add('active');
        }

        function openDeleteAccountModal() {
            deleteAccountModal.classList.add('active');
        }

        // Settings
        function toggleNotificationSettings() {
            const toggle = document.getElementById('notificationToggle');
            toggle.classList.toggle('active');
            const isEnabled = toggle.classList.contains('active');
            showToast(`Notifications ${isEnabled ? 'enabled' : 'disabled'}`, 'info');
            
            // Save preference to localStorage
            localStorage.setItem('notificationsEnabled', isEnabled);
        }

        // Delete account
        async function deleteAccount() {
            const confirmText = document.getElementById('deleteConfirm').value;
            
            if (confirmText !== 'DELETE') {
                showToast('Please type DELETE to confirm', 'warning');
                return;
            }

            try {
                showToast('Deleting account...', 'info');
                
                // Note: This requires admin/supabase settings to allow user deletion
                // Usually handled by admin or via edge functions
                const { error } = await sb.rpc('delete_user_account');
                
                if (error) throw error;

                await sb.auth.signOut();
                showToast('Account deleted successfully', 'success');
                deleteAccountModal.classList.remove('active');
                renderLoggedOutUI();

            } catch (error) {
                console.error('Error deleting account:', error);
                showToast('Failed to delete account. Please contact support.', 'error');
            }
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.classList.add('show');
            
            if (type === 'error') {
                toast.style.background = '#EF4444';
            } else if (type === 'success') {
                toast.style.background = '#10B981';
            } else if (type === 'warning') {
                toast.style.background = '#F59E0B';
            } else {
                toast.style.background = '#1F2937';
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.style.background = '#1F2937';
                }, 300);
            }, 3000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Edit profile modal
            document.getElementById('cancelEdit').addEventListener('click', () => {
                editProfileModal.classList.remove('active');
            });

            document.getElementById('saveEdit').addEventListener('click', saveProfile);

            // Logout modal
            document.getElementById('cancelLogout').addEventListener('click', () => {
                logoutModal.classList.remove('active');
            });

            document.getElementById('confirmLogout').addEventListener('click', logout);

            // Delete account modal
            document.getElementById('cancelDelete').addEventListener('click', () => {
                deleteAccountModal.classList.remove('active');
                document.getElementById('deleteConfirm').value = '';
            });

            document.getElementById('confirmDelete').addEventListener('click', deleteAccount);

            // Close modals on click outside
            [editProfileModal, logoutModal, deleteAccountModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        });

        // Export functions for global use
        window.login = login;
        window.openEditProfile = openEditProfile;
        window.openLogoutModal = openLogoutModal;
        window.openDeleteAccountModal = openDeleteAccountModal;
        window.toggleNotificationSettings = toggleNotificationSettings;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- AGGRESSIVE MOBILE OPTIMIZATION - 99% MOBILE FIRST -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover, shrink-to-fit=no">
  <meta name="theme-color" content="#0B4F6C">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <title>Create Account Â· iBlue Uganda</title>
  <!-- INTER FONT WITH FALLBACKS - PERFECT MOBILE RENDERING -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* RESET WITH MOBILE-FIRST FORCE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at 10% 30%, #0B4F6C, #0a3b4f);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ULTRA-RESPONSIVE CARD - 100% WIDTH ON ALL MOBILES */
    .card {
      background: rgba(255, 255, 255, 0.98);
      width: 100%;
      max-width: 480px;
      padding: 32px 24px;
      padding: max(24px, env(safe-area-inset-left)) max(24px, env(safe-area-inset-right));
      border-radius: 36px;
      box-shadow: 0 30px 60px -20px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.1) inset;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.2s ease;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
      font-size: 38px;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(145deg, #0B4F6C, #1a6a8a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: #4a6a7c;
      margin-bottom: 32px;
      font-size: 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: rgba(11,79,108,0.04);
      padding: 8px 16px;
      border-radius: 40px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }

    .field {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #1E293B;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    /* PERFECT TOUCH TARGET - MIN 48px */
    input {
      width: 100%;
      padding: 16px 18px;
      border-radius: 20px;
      border: 1.8px solid #E2E8F0;
      font-size: 16px;
      background: #F8FAFC;
      transition: all 0.18s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      color: #0a2e3a;
      -webkit-appearance: none;
      appearance: none;
    }

    input:focus {
      border-color: #0B4F6C;
      background: white;
      outline: none;
      box-shadow: 0 0 0 4px rgba(11,79,108,0.12);
    }

    /* AUTOCOMPLETE STYLE FIX */
    input:-webkit-autofill {
      -webkit-box-shadow: 0 0 0 50px #F8FAFC inset;
      -webkit-text-fill-color: #0a2e3a;
    }

    .password-requirements {
      margin-top: 10px;
      font-size: 13px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .requirement {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #64748B;
      font-weight: 500;
      padding: 4px 0;
      transition: color 0.15s;
    }

    .requirement span:first-child {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      font-size: 16px;
    }

    .requirement.met {
      color: #0B4F6C;
    }

    .requirement.met span:first-child {
      color: #16a34a;
      font-weight: 700;
    }

    /* PRIMARY CTA - BOLD, TAPPABLE */
    button {
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-radius: 100px; /* PILL SHAPE - MODERN */
      background: #0B4F6C;
      color: white;
      font-weight: 700;
      font-size: 17px;
      cursor: pointer;
      margin-top: 8px;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.18s;
      box-shadow: 0 10px 25px -8px rgba(11,79,108,0.4);
      letter-spacing: 0.3px;
    }

    button:active {
      transform: scale(0.98);
      box-shadow: 0 5px 15px -5px rgba(11,79,108,0.6);
    }

    button:disabled {
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }

    .google-btn {
      background: white;
      color: #1E293B;
      border: 1.8px solid #E2E8F0;
      box-shadow: 0 4px 10px -2px rgba(0,0,0,0.05);
      font-weight: 600;
    }

    .google-btn:active {
      background: #F8FAFC;
      border-color: #0B4F6C;
    }

    /* DIVIDER - CRISP ON MOBILE */
    .divider {
      display: flex;
      align-items: center;
      margin: 28px 0 20px;
      color: #64748B;
      font-size: 14px;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      border-bottom: 1.5px solid #E2E8F0;
    }

    .divider span {
      margin: 0 16px;
      color: #5a7184;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* LOGIN LINK - BIG TAP AREA */
    .login-prompt {
      text-align: center;
      margin-top: 28px;
      padding-top: 20px;
      border-top: 1.5px solid #EDF2F7;
      color: #4a5c6b;
      font-size: 16px;
      font-weight: 500;
    }

    .login-prompt a {
      color: #0B4F6C;
      text-decoration: none;
      font-weight: 700;
      padding: 12px 8px;
      margin-left: 6px;
      display: inline-block;
      border-radius: 40px;
      transition: background 0.15s;
    }

    .login-prompt a:active {
      background: rgba(11,79,108,0.08);
    }

    /* MESSAGE TOAST - MOBILE OPTIMIZED */
    .msg {
      margin-top: 24px;
      padding: 16px 20px;
      border-radius: 100px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      display: none;
      word-break: break-word;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .msg.show {
      display: block;
      animation: slideUp 0.25s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.success {
      background: rgba(240, 253, 244, 0.95);
      color: #166534;
      border: 1px solid #86EFAC;
      box-shadow: 0 4px 12px rgba(22,101,52,0.1);
    }

    .msg.error {
      background: rgba(254, 242, 242, 0.95);
      color: #991B1B;
      border: 1px solid #FECACA;
    }

    .msg.info {
      background: rgba(239, 246, 255, 0.95);
      color: #1E40AF;
      border: 1px solid #BFDBFE;
    }

    /* LOADING SPINNER - SILKY SMOOTH */
    .loading-spinner {
      display: inline-block;
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.7s linear infinite;
    }

    .google-btn .loading-spinner {
      border: 3px solid rgba(11,79,108,0.15);
      border-top-color: #0B4F6C;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* EXTRA TINY SCREENS (iPhone SE, etc) */
    @media (max-width: 380px) {
      .card { padding: 24px 18px; }
      h1 { font-size: 34px; }
      input { padding: 14px 16px; }
    }

    /* LANDSCAPE MODE - COMPACT */
    @media (max-height: 600px) and (orientation: landscape) {
      body { padding: 8px; }
      .card { padding: 20px 24px; }
      .field { margin-bottom: 12px; }
    }

    /* SAFARI BOTTOM BAR FIX */
    @supports (padding: max(0px)) {
      .card {
        padding-bottom: max(24px, env(safe-area-inset-bottom));
      }
    }

    /* GOOGLE ICON - INLINED SVG (ZERO REQUESTS) */
    .google-icon {
      display: inline-block;
      width: 22px;
      height: 22px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="%23FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="%2323A1F1" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="%2334A853" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="%23EA4335" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>') no-repeat center;
      background-size: contain;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>iBlue</h1>
    <div class="subtitle">
      <span>ðŸ‡ºðŸ‡¬</span> Create your account
    </div>

    <div class="field">
      <label>Full name</label>
      <input id="name" type="text" placeholder="e.g. Nakato Sarah" autocomplete="name" inputmode="text" />
    </div>

    <div class="field">
      <label>Email address</label>
      <input id="email" type="email" placeholder="e.g. nakato@gmail.com" autocomplete="email" inputmode="email" autocapitalize="off" spellcheck="false" />
    </div>

    <div class="field">
      <label>Password</label>
      <input id="password" type="password" placeholder="Create a strong password" autocomplete="new-password" />
      <div class="password-requirements">
        <span class="requirement" id="lengthReq">
          <span id="lengthIcon">â—‹</span> 6+ characters
        </span>
      </div>
    </div>

    <div class="field">
      <label>Confirm password</label>
      <input id="confirmPassword" type="password" placeholder="Re-enter your password" autocomplete="new-password" />
      <div class="password-requirements">
        <span class="requirement" id="matchReq">
          <span id="matchIcon">â—‹</span> Passwords match
        </span>
      </div>
    </div>

    <button id="registerBtn">Create Account</button>

    <div class="divider">
      <span>OR</span>
    </div>

    <button id="googleBtn" class="google-btn">
      <span class="google-icon" aria-hidden="true"></span>
      Continue with Google
    </button>

    <div class="login-prompt">
      Already have an account? <a href="login.html">Sign in â†’</a>
    </div>

    <div id="msg" class="msg"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function() {
      'use strict';

      // --- SUPABASE CONFIG - PROFESSIONAL SETUP ---
      const supabaseUrl = "https://uufhvmmgwzkxvvdbqemz.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1Zmh2bW1nd3preHZ2ZGJxZW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDIzNTYsImV4cCI6MjA4NTg3ODM1Nn0.WABHx4ilFRkhPHP-y4ZC4E8Kb7PRqY-cyxI8cVS8Tyc";
      
      const sb = window.supabase.createClient(supabaseUrl, supabaseKey, {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true,
          flowType: 'pkce',    // RECOMMENDED FOR MOBILE
        }
      });

      // --- ALL ALLOWED REDIRECT URLs (MATCHING SUPABASE CONFIG) ---
      const ALLOWED_REDIRECTS = [
        'https://iblueug.github.io/dashboard.html',
        'https://iblueug.github.io/messages.html',
        'https://iblueug.github.io/profile.html',
        'https://iblueug.github.io/chat.html',
        'https://iblueug.github.io/my-ads.html',
        'https://iblueug.github.io/post-ad.html',
        'https://iblueug.github.io/saved-ads.html'
      ];

      // --- DEFAULT REDIRECT AFTER SUCCESSFUL REGISTRATION ---
      const DEFAULT_REDIRECT = 'https://iblueug.github.io/dashboard.html';

      // --- SAFE REDIRECT VALIDATOR ---
      function getSafeRedirect(redirectTo) {
        if (redirectTo && ALLOWED_REDIRECTS.includes(redirectTo)) {
          return redirectTo;
        }
        
        // Check session storage for stored redirect
        const storedRedirect = sessionStorage.getItem('postLoginRedirect');
        if (storedRedirect && ALLOWED_REDIRECTS.includes(storedRedirect)) {
          sessionStorage.removeItem('postLoginRedirect');
          return storedRedirect;
        }
        
        return DEFAULT_REDIRECT;
      }

      // --- CHECK FOR REDIRECT PARAMETER IN URL ---
      function checkForRedirectParam() {
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect');
        if (redirect && ALLOWED_REDIRECTS.includes(redirect)) {
          sessionStorage.setItem('postLoginRedirect', redirect);
          // Clean URL without refreshing
          const cleanUrl = window.location.pathname;
          history.replaceState({}, document.title, cleanUrl);
        }
      }

      // --- DOM ELEMENTS ---
      const msg = document.getElementById("msg");
      const registerBtn = document.getElementById("registerBtn");
      const googleBtn = document.getElementById("googleBtn");
      const nameInput = document.getElementById("name");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const confirmInput = document.getElementById("confirmPassword");
      const lengthReq = document.getElementById("lengthReq");
      const matchReq = document.getElementById("matchReq");
      const lengthIcon = document.getElementById("lengthIcon");
      const matchIcon = document.getElementById("matchIcon");

      // --- TOAST MESSAGING (PRO) ---
      function showMessage(text, type = 'error') {
        if (!msg) return;
        msg.textContent = text;
        msg.className = 'msg show ' + type;
        
        if (type === 'success' || type === 'info') {
          setTimeout(() => {
            msg.classList.remove('show');
          }, 4800);
        }
      }

      // --- LOADING STATE MANAGER (PREVENTS DOUBLE TAP) ---
      function setLoading(button, isLoading) {
        if (!button) return;
        
        if (isLoading) {
          button.disabled = true;
          if (!button.dataset.originalHTML) {
            button.dataset.originalHTML = button.innerHTML;
          }
          
          if (button.classList.contains('google-btn')) {
            button.innerHTML = '<span class="loading-spinner"></span> Connecting...';
          } else {
            button.innerHTML = '<span class="loading-spinner"></span> Creating account...';
          }
        } else {
          button.disabled = false;
          if (button.dataset.originalHTML) {
            button.innerHTML = button.dataset.originalHTML;
          }
        }
      }

      // --- LIVE VALIDATION (IMMEDIATE FEEDBACK) ---
      function validatePassword() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        // Length check
        if (password.length >= 6) {
          lengthReq.classList.add('met');
          lengthIcon.textContent = 'âœ“';
        } else {
          lengthReq.classList.remove('met');
          lengthIcon.textContent = 'â—‹';
        }
        
        // Match check
        if (password && confirm && password === confirm) {
          matchReq.classList.add('met');
          matchIcon.textContent = 'âœ“';
        } else {
          matchReq.classList.remove('met');
          matchIcon.textContent = 'â—‹';
        }
      }

      passwordInput.addEventListener('input', validatePassword);
      confirmInput.addEventListener('input', validatePassword);

      // --- GOOGLE SIGN-IN (PKCE COMPATIBLE) ---
      async function signInWithGoogle(e) {
        if (e) e.preventDefault();
        
        setLoading(googleBtn, true);
        
        try {
          const redirectTo = getSafeRedirect();
          
          const { data, error } = await sb.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: redirectTo, // DYNAMIC SAFE REDIRECT
              queryParams: {
                access_type: 'offline',
                prompt: 'consent'
              }
            }
          });
          
          if (error) {
            showMessage(error.message || 'Google sign-in failed', 'error');
            setLoading(googleBtn, false);
          }
          // SUCCESS = REDIRECT, NO NEED TO HANDLE
        } catch (err) {
          showMessage('Network error. Please try again.', 'error');
          console.error('Google OAuth error:', err);
          setLoading(googleBtn, false);
        }
      }

      // --- EMAIL REGISTRATION (WITH METADATA) ---
      async function register(e) {
        if (e) e.preventDefault();
        
        // GET VALUES
        const full_name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        // VALIDATION (ZERO TOLERANCE)
        if (!full_name) {
          showMessage('Please enter your full name', 'error');
          nameInput.focus();
          return;
        }
        
        if (!email) {
          showMessage('Email address is required', 'error');
          emailInput.focus();
          return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage('Enter a valid email address', 'error');
          emailInput.focus();
          return;
        }
        
        if (!password) {
          showMessage('Create a password', 'error');
          passwordInput.focus();
          return;
        }
        
        if (password.length < 6) {
          showMessage('Password must be at least 6 characters', 'error');
          passwordInput.focus();
          return;
        }
        
        if (password !== confirm) {
          showMessage('Passwords do not match', 'error');
          confirmInput.focus();
          return;
        }

        // LOCK BUTTON
        setLoading(registerBtn, true);
        
        try {
          const redirectTo = getSafeRedirect();
          
          const { data, error } = await sb.auth.signUp({
            email,
            password,
            options: {
              data: {
                full_name: full_name,
                created_at: new Date().toISOString(),
              },
              emailRedirectTo: redirectTo // DYNAMIC SAFE REDIRECT
            }
          });
          
          if (error) {
            showMessage(error.message, 'error');
            setLoading(registerBtn, false);
            return;
          }
          
          // SUCCESS
          showMessage('âœ“ Account created! Redirecting...', 'success');
          
          setTimeout(() => {
            window.location.href = redirectTo;
          }, 1500);
          
        } catch (err) {
          showMessage('Registration failed. Check connection.', 'error');
          console.error('Signup error:', err);
          setLoading(registerBtn, false);
        }
      }

      // --- SESSION CHECK (PREVENT LOGGED-IN USERS) ---
      async function checkExistingSession() {
        try {
          const { data, error } = await sb.auth.getSession();
          if (data && data.session) {
            const redirectTo = getSafeRedirect();
            window.location.replace(redirectTo);
          }
        } catch (e) {
          // SILENT FAIL - STAY ON PAGE
        }
      }

      // --- ATTACH EVENT LISTENERS (NO INLINE ONCLICK) ---
      registerBtn.addEventListener('click', register);
      googleBtn.addEventListener('click', signInWithGoogle);

      // ENTER KEY SUPPORT (MOBILE KEYBOARD)
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          confirmInput.focus();
        }
      });
      
      confirmInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          register(e);
        }
      });

      emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          passwordInput.focus();
        }
      });

      // INITIAL SESSION CHECK
      document.addEventListener('DOMContentLoaded', () => {
        checkForRedirectParam();
        checkExistingSession();
      });

      // EXPOSE FOR DEBUGGING (OPTIONAL, NOT REQUIRED)
      window.register = register;
      window.signInWithGoogle = signInWithGoogle;

      // HANDLE OAuth ERROR HASH
      if (window.location.hash && window.location.hash.includes('error=')) {
        try {
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const errorMsg = hashParams.get('error_description') || hashParams.get('error') || 'Authentication failed';
          showMessage(decodeURIComponent(errorMsg), 'error');
          // CLEAN URL
          history.replaceState(null, '', window.location.pathname);
        } catch (e) {}
      }
    })();
  </script>
</body>
</html>
